<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÇ¨Ï£ºÏõêÍµ≠ Ï°∞Ìöå</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .result-box {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: none;
        }
        .ganji-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-bottom: 20px;
            direction: rtl;
        }
        .ganji-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
            direction: ltr;
        }
        .ganji-box {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin: 5px;
            font-size: 24px;
            background-color: #f8f9fa;
            writing-mode: vertical-rl;
            text-orientation: upright;
        }
        .ganji-label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #666;
        }
        .daewoon-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-top: 20px;
            direction: ltr;
        }
        .daewoon-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
        }
        .daewoon-box {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            border: 2px solid #28a745;
            border-radius: 5px;
            margin: 5px;
            font-size: 24px;
            background-color: #f8f9fa;
            writing-mode: vertical-rl;
            text-orientation: upright;
        }
        .daewoon-count {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ÏÉÅÎã®: Ï†úÎ™© + Î≤ÑÌäº Í∞ÄÎ°ú Î∞∞Ïπò -->
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div style="font-size:1.7rem; font-weight:bold; color:#d32f2f; letter-spacing:-1px; white-space:nowrap;">
                IFL ÎßåÏÑ∏Î†•
            </div>
            <div>
                <button id="saveSajuBtn" class="btn btn-outline-secondary btn-sm" title="ÏÇ¨Ï£º Ï†ÄÏû•">üíæ Ï†ÄÏû•</button>
                <button id="loadSajuBtn" class="btn btn-outline-secondary btn-sm ms-2" title="Ï†ÄÏû•Îêú ÏÇ¨Ï£º Ï°∞Ìöå">üìÇ Ï°∞Ìöå</button>
                <button id="recentSajuBtn" class="btn btn-outline-secondary btn-sm ms-2" title="ÏµúÍ∑º Ï°∞Ìöå">üïë ÏµúÍ∑º</button>
                <button id="calendarBtn" class="btn btn-outline-secondary btn-sm ms-2" title="Îã¨Î†• Î≥¥Í∏∞">üìÖ Îã¨Î†•</button>
            </div>
        </div>

        <!-- ÏûÖÎ†• Ìèº: ÎùºÎ≤® ÏÇ≠Ï†ú, Ìïú Ï§ÑÎ°ú Ï†ïÎ†¨, Î≤ÑÌäºÎ™Ö 'Ï°∞Ìöå'Î°ú Î≥ÄÍ≤Ω -->
        <form id="sajuForm" class="mb-4">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <select class="form-control form-control-sm" id="gender" required style="min-width:60px;">
                        <option value="M">ÎÇ®Ïûê</option>
                        <option value="F" selected>Ïó¨Ïûê</option>
                    </select>
                </div>
                <div class="col-auto">
                    <select class="form-control form-control-sm" id="calendarType" required style="min-width:60px;">
                        <option value="solar">ÏñëÎ†•</option>
                        <option value="lunar">ÏùåÎ†•</option>
                    </select>
                </div>
                <div class="col-auto">
                    <input type="text" class="form-control form-control-sm" id="datetimeInput" maxlength="12" placeholder="YYYYMMDDHHmm" required style="width:120px;">
                </div>
                <div class="col-auto">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="unknownHour">
                        <label class="form-check-label" for="unknownHour" style="font-size:0.95em;">Ïãú Î™®Î¶Ñ</label>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary btn-sm">Ï°∞Ìöå</button>
                </div>
            </div>
        </form>

        <!-- Ï†ÄÏû• Î©îÎ™® ÏûÖÎ†• Î™®Îã¨ -->
        <div id="saveModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
          <div style="background:#fff; padding:20px; border-radius:10px; min-width:300px;">
            <div>Ïù¥Î¶Ñ <input id="saveMemo" maxlength="30" style="width:200px;"></div>
            <div class="mt-2 text-end">
              <button id="saveModalOk" class="btn btn-primary btn-sm">Ï†ÄÏû•</button>
              <button id="saveModalCancel" class="btn btn-secondary btn-sm">Ï∑®ÏÜå</button>
            </div>
          </div>
        </div>
        <!-- Ï†ÄÏû• Î¶¨Ïä§Ìä∏ Î™®Îã¨ -->
        <div id="loadModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
          <div style="background:#fff; padding:20px; border-radius:10px; min-width:350px; max-height:80vh; overflow-y:auto;">
            <div style="font-weight:bold; margin-bottom:10px;">Ï†ÄÏû•Îêú ÏÇ¨Ï£º</div>
            <div id="loadList"></div>
            <div class="mt-2 text-end">
              <button id="loadModalClose" class="btn btn-secondary btn-sm">Îã´Í∏∞</button>
            </div>
          </div>
        </div>
        <!-- ÏµúÍ∑º Î¶¨Ïä§Ìä∏ Î™®Îã¨ -->
        <div id="recentModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
          <div style="background:#fff; padding:20px; border-radius:10px; min-width:350px; max-height:80vh; overflow-y:auto;">
            <div style="font-weight:bold; margin-bottom:10px;">ÏµúÍ∑º Ï°∞ÌöåÌïú ÏÇ¨Ï£º</div>
            <div id="recentList"></div>
            <div class="mt-2 text-end">
              <button id="recentModalClose" class="btn btn-secondary btn-sm">Îã´Í∏∞</button>
            </div>
          </div>
        </div>

        <div id="result" class="result-box">           
            <!-- ÏÇ¨Ï£ºÏõêÍµ≠ Ï†ïÎ≥¥ ÏúóÏ§ÑÏóê ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥ Ï∂îÍ∞Ä -->
            <div id="sajuInfoBar" style="text-align:center; font-size:1.05em; margin-bottom:10px; color:#333; font-weight:500;">
                <span id="infoSolarDate"></span>
                <span id="infoLunarDate" style="margin-left:10px;"></span>
                <span id="infoAge" style="margin-left:10px;"></span>
                <span id="infoGender" style="margin-left:10px;"></span>
            </div>
            <div class="ganji-container">
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="yearGanSibsin"></span> </div>
                    <div class="ganji-box" id="yearGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="yearJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="yearJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="yearShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="yearUnseong"></span> </div>
                </div>
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="monthGanSibsin"></span> </div>
                    <div class="ganji-box" id="monthGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="monthJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="monthJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="monthShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="monthUnseong"></span> </div>
                </div>
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="dayGanSibsin"></span> </div>
                    <div class="ganji-box" id="dayGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="dayJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="dayJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="dayShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="dayUnseong"></span> </div>
                </div>
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="hourGanSibsin"></span> </div>
                    <div class="ganji-box" id="hourGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="hourJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="hourJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="hourShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="hourUnseong"></span> </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="daewoon-container" id="daewoonContainer">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ïã≠Ïã† Í≥ÑÏÇ∞ Ìï®Ïàò (Ï†ÑÏó≠ ÏÑ†Ïñ∏)
        function getSibsin(dayGan, target, isGan) {
            if (!dayGan || !target || target.length !== 1) return '';
            const sibsinGan = {
                'Áî≤': ['ÎπÑÍ≤¨','Í≤ÅÏû¨','ÏãùÏã†','ÏÉÅÍ¥Ä','Ìé∏Ïû¨','Ï†ïÏû¨','Ìé∏Í¥Ä','Ï†ïÍ¥Ä','Ìé∏Ïù∏','Ï†ïÏù∏'],
                '‰πô': ['Í≤ÅÏû¨','ÎπÑÍ≤¨','ÏÉÅÍ¥Ä','ÏãùÏã†','Ï†ïÏû¨','Ìé∏Ïû¨','Ï†ïÍ¥Ä','Ìé∏Í¥Ä','Ï†ïÏù∏','Ìé∏Ïù∏'],
                '‰∏ô': ['Ìé∏Ïù∏','Ï†ïÏù∏','ÎπÑÍ≤¨','Í≤ÅÏû¨','ÏãùÏã†','ÏÉÅÍ¥Ä','Ìé∏Ïû¨','Ï†ïÏû¨','Ìé∏Í¥Ä','Ï†ïÍ¥Ä'],
                '‰∏Å': ['Ï†ïÏù∏','Ìé∏Ïù∏','Í≤ÅÏû¨','ÎπÑÍ≤¨','ÏÉÅÍ¥Ä','ÏãùÏã†','Ï†ïÏû¨','Ìé∏Ïû¨','Ï†ïÍ¥Ä','Ìé∏Í¥Ä'],
                'Êàä': ['Ìé∏Í¥Ä','Ï†ïÍ¥Ä','Ìé∏Ïù∏','Ï†ïÏù∏','ÎπÑÍ≤¨','Í≤ÅÏû¨','ÏãùÏã†','ÏÉÅÍ¥Ä','Ìé∏Ïû¨','Ï†ïÏû¨'],
                'Â∑±': ['Ï†ïÍ¥Ä','Ìé∏Í¥Ä','Ï†ïÏù∏','Ìé∏Ïù∏','Í≤ÅÏû¨','ÎπÑÍ≤¨','ÏÉÅÍ¥Ä','ÏãùÏã†','Ï†ïÏû¨','Ìé∏Ïû¨'],
                'Â∫ö': ['Ìé∏Ïû¨','Ï†ïÏû¨','Ìé∏Í¥Ä','Ï†ïÍ¥Ä','Ìé∏Ïù∏','Ï†ïÏù∏','ÎπÑÍ≤¨','Í≤ÅÏû¨','ÏãùÏã†','ÏÉÅÍ¥Ä'],
                'Ëæõ': ['Ï†ïÏû¨','Ìé∏Ïû¨','Ï†ïÍ¥Ä','Ìé∏Í¥Ä','Ï†ïÏù∏','Ìé∏Ïù∏','Í≤ÅÏû¨','ÎπÑÍ≤¨','ÏÉÅÍ¥Ä','ÏãùÏã†'],
                'Â£¨': ['ÏãùÏã†','ÏÉÅÍ¥Ä','Ìé∏Ïû¨','Ï†ïÏû¨','Ìé∏Í¥Ä','Ï†ïÍ¥Ä','Ìé∏Ïù∏','Ï†ïÏù∏','ÎπÑÍ≤¨','Í≤ÅÏû¨'],
                'Áô∏': ['ÏÉÅÍ¥Ä','ÏãùÏã†','Ï†ïÏû¨','Ìé∏Ïû¨','Ï†ïÍ¥Ä','Ìé∏Í¥Ä','Ï†ïÏù∏','Ìé∏Ïù∏','Í≤ÅÏû¨','ÎπÑÍ≤¨'],
            };
            const sibsinJi = {
                'Áî≤': ['Ï†ïÏù∏','Ï†ïÏû¨','ÎπÑÍ≤¨','Í≤ÅÏû¨','Ìé∏Ïû¨','ÏãùÏã†','ÏÉÅÍ¥Ä','Ï†ïÏû¨','Ìé∏Í¥Ä','Ï†ïÍ¥Ä','Ìé∏Ïû¨','Ìé∏Ïù∏'],
                '‰πô': ['Ìé∏Ïù∏','Ìé∏Ïû¨','Í≤ÅÏû¨','ÎπÑÍ≤¨','Ï†ïÏû¨','ÏÉÅÍ¥Ä','ÏãùÏã†','Ìé∏Ïû¨','Ï†ïÍ¥Ä','Ìé∏Í¥Ä','Ï†ïÏû¨','Ï†ïÏù∏'],
                '‰∏ô': ['Ï†ïÍ¥Ä','ÏÉÅÍ¥Ä','Ìé∏Ïù∏','Ï†ïÏù∏','ÏãùÏã†','ÎπÑÍ≤¨','Í≤ÅÏû¨','ÏÉÅÍ¥Ä','Ìé∏Ïû¨','Ï†ïÏû¨','ÏãùÏã†','Ìé∏Í¥Ä'],
                '‰∏Å': ['Ìé∏Í¥Ä','ÏãùÏã†','Ï†ïÏù∏','Ìé∏Ïù∏','ÏÉÅÍ¥Ä','Í≤ÅÏû¨','ÎπÑÍ≤¨','ÏãùÏã†','Ï†ïÏû¨','Ìé∏Ïû¨','ÏÉÅÍ¥Ä','Ï†ïÍ¥Ä'],
                'Êàä': ['Ï†ïÏû¨','Í≤ÅÏû¨','Ìé∏Í¥Ä','Ï†ïÍ¥Ä','ÎπÑÍ≤¨','Ìé∏Ïù∏','Ï†ïÏù∏','Í≤ÅÏû¨','ÏãùÏã†','ÏÉÅÍ¥Ä','ÎπÑÍ≤¨','Ìé∏Ïû¨'],
                'Â∑±': ['Ìé∏Ïû¨','ÎπÑÍ≤¨','Ìé∏Í¥Ä','Ï†ïÍ¥Ä','Í≤ÅÏû¨','Ï†ïÏù∏','Ìé∏Ïù∏','ÎπÑÍ≤¨','ÏÉÅÍ¥Ä','ÏãùÏã†','Í≤ÅÏû¨','Ï†ïÏû¨'],
                'Â∫ö': ['ÏÉÅÍ¥Ä','Ï†ïÏù∏','Ìé∏Ïû¨','Ï†ïÏû¨','Ìé∏Ïù∏','Ìé∏Í¥Ä','Ï†ïÍ¥Ä','Ï†ïÏù∏','ÎπÑÍ≤¨','Í≤ÅÏû¨','Ìé∏Ïù∏','ÏãùÏã†'],
                'Ëæõ': ['ÏãùÏã†','Ìé∏Ïù∏','Ï†ïÏû¨','Ìé∏Ïû¨','Ï†ïÏù∏','Ï†ïÍ¥Ä','Ìé∏Í¥Ä','Ìé∏Ïù∏','Í≤ÅÏû¨','ÎπÑÍ≤¨','Ï†ïÏù∏','ÏÉÅÍ¥Ä'],
                'Â£¨': ['Í≤ÅÏû¨','Ï†ïÍ¥Ä','ÏãùÏã†','ÏÉÅÍ¥Ä','Ìé∏Í¥Ä','Ìé∏Ïû¨','Ï†ïÏû¨','Ï†ïÍ¥Ä','Ìé∏Ïù∏','Ï†ïÏù∏','Ìé∏Í¥Ä','ÎπÑÍ≤¨'],
                'Áô∏': ['ÎπÑÍ≤¨','Ìé∏Í¥Ä','ÏÉÅÍ¥Ä','ÏãùÏã†','Ï†ïÍ¥Ä','Ï†ïÏû¨','Ìé∏Ïû¨','Ìé∏Í¥Ä','Ï†ïÏù∏','Ìé∏Ïù∏','Ï†ïÍ¥Ä','Í≤ÅÏû¨'],
            };
            const ganList = ['Áî≤','‰πô','‰∏ô','‰∏Å','Êàä','Â∑±','Â∫ö','Ëæõ','Â£¨','Áô∏'];
            const jiList = ['Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•'];
            if (isGan) {
                if (!target || ganList.indexOf(target) === -1) return '';
                return sibsinGan[dayGan][ganList.indexOf(target)];
            } else {
                if (!target || jiList.indexOf(target) === -1) return '';
                return sibsinJi[dayGan][jiList.indexOf(target)];
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú datetimeInputÏóê ÌòÑÏû¨ ÎÇ†Ïßú/ÏãúÍ∞Ñ ÏûêÎèô ÏûÖÎ†•
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const yyyy = now.getFullYear().toString();
            const mm = (now.getMonth() + 1).toString().padStart(2, '0');
            const dd = now.getDate().toString().padStart(2, '0');
            const hh = now.getHours().toString().padStart(2, '0');
            const min = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('datetimeInput').value = `${yyyy}${mm}${dd}${hh}${min}`;
            // Ìèº ÏûêÎèô Ï†úÏ∂ú
            setTimeout(() => {
                document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
            }, 100); // ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥Î°ú Î†åÎçîÎßÅ Î≥¥Ïû•
        });

        // datetimeInputÏóêÏÑú ÎÖÑ,Ïõî,Ïùº,Ïãú,Î∂Ñ Ï∂îÏ∂ú Ìï®Ïàò
        function getDateTimeParts() {
            const datetimeStr = document.getElementById('datetimeInput').value.trim();
            return {
                year: parseInt(datetimeStr.slice(0, 4), 10),
                month: parseInt(datetimeStr.slice(4, 6), 10),
                day: parseInt(datetimeStr.slice(6, 8), 10),
                hour: parseInt(datetimeStr.slice(8, 10), 10),
                minute: parseInt(datetimeStr.slice(10, 12), 10)
            };
        }

        document.getElementById('sajuForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const unknown_hour = document.getElementById('unknownHour').checked;
            const datetimeStr = document.getElementById('datetimeInput').value.trim();

            if (unknown_hour) {
                // Ïãú Î™®Î¶Ñ: 8ÏûêÎ¶¨(YYYYMMDD)Îßå ÌóàÏö©
                if (!/^[0-9]{8}$/.test(datetimeStr)) {
                    alert('ÏûÖÎ†•Ïò§Î•ò: Ïãú Î™®Î¶ÑÏùº ÎïåÎäî 8ÏûêÎ¶¨(YYYYMMDD)Î°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                    return;
                }
            } else {
                // Ïãú Î™®Î¶Ñ Ìï¥Ï†ú: 12ÏûêÎ¶¨(YYYYMMDDHHmm)Îßå ÌóàÏö©
                if (!/^[0-9]{12}$/.test(datetimeStr)) {
                    alert('ÏûÖÎ†•Ïò§Î•ò: 12ÏûêÎ¶¨(YYYYMMDDHHmm)Î°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                    return;
                }
            }

            const year = parseInt(datetimeStr.slice(0, 4), 10);
            const month = parseInt(datetimeStr.slice(4, 6), 10);
            const day = parseInt(datetimeStr.slice(6, 8), 10);
            let hour = 0, minute = 0;
            if (!unknown_hour) {
                hour = parseInt(datetimeStr.slice(8, 10), 10);
                minute = parseInt(datetimeStr.slice(10, 12), 10);
            }

            const gender = document.getElementById('gender').value;
            const is_lunar = document.getElementById('calendarType').value === 'lunar';

            try {
                const response = await fetch('/get_saju', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ year, month, day, hour, minute, gender, is_lunar, unknown_hour }),
                });

                const data = await response.json();
                
                if (response.ok && data && typeof data === 'object' && !data.error) {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('yearGanji').textContent = data.year_ganji;
                    document.getElementById('monthGanji').textContent = data.month_ganji;
                    document.getElementById('dayGanji').textContent = data.day_ganji;
                    document.getElementById('hourGanji').textContent = data.hour_ganji;
                    document.getElementById('yearGanSibsin').textContent = data.sibsin.year_gan;
                    document.getElementById('yearJiSibsin').textContent = data.sibsin.year_ji;
                    document.getElementById('monthGanSibsin').textContent = data.sibsin.month_gan;
                    document.getElementById('monthJiSibsin').textContent = data.sibsin.month_ji;
                    document.getElementById('dayGanSibsin').textContent = data.sibsin.day_gan;
                    document.getElementById('dayJiSibsin').textContent = data.sibsin.day_ji;
                    document.getElementById('hourGanSibsin').textContent = (data.sibsin && data.sibsin.hour_gan) ? data.sibsin.hour_gan : '';
                    document.getElementById('hourJiSibsin').textContent = (data.sibsin && data.sibsin.hour_ji) ? data.sibsin.hour_ji : '';

                    console.log('sibsin:', data.sibsin);

                    // ÎåÄÏö¥Ïàò ÌëúÏãú
                    const daewoonContainer = document.getElementById('daewoonContainer');
                    daewoonContainer.innerHTML = '';
                    const total = data.daewoon.length;
                    const baseAge = data.daewoon[0].daewoon_count;
                    const reversed = data.daewoon.slice().reverse();
                    // ÎåÄÏö¥ ÎùºÏù∏ ÏÉùÏÑ± Î∞è ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∂ÄÏó¨
                    reversed.forEach((daewoon, idx) => {
                        const column = document.createElement('div');
                        column.className = 'daewoon-column';
                        let ageLabel = '';
                        let blockIdx = null;
                        if (idx === total - 1) {
                            ageLabel = 'ÎåÄÏö¥';
                        } else if (idx === total - 2) {
                            ageLabel = baseAge;
                            blockIdx = 0;
                        } else if (idx < total - 2) {
                            ageLabel = baseAge + (total - 2 - idx) * 10;
                            blockIdx = (total - 2 - idx);
                        }
                        // Ïã≠Ïã† Í≥ÑÏÇ∞ (ÎåÄÏö¥ Í∞ÑÏßÄ, ÏùºÍ∞Ñ Í∏∞Ï§Ä)
                        let ganSibsin = '', jiSibsin = '';
                        if (daewoon.ganji && data.day_ganji) {
                            const dayGan = data.day_ganji[0];
                            const gan = daewoon.ganji[0];
                            const ji = daewoon.ganji[1];
                            ganSibsin = getSibsin(dayGan, gan, true);
                            jiSibsin = getSibsin(dayGan, ji, false);
                        }
                        column.innerHTML = `
                            <div class="daewoon-age" style="font-weight:bold; cursor:pointer; margin-bottom:2px;">${ageLabel}</div>
                            <div style="font-size:13px; color:#888; height:18px;">${ganSibsin}</div>
                            <div class="daewoon-box" style="cursor:pointer;">${daewoon.ganji}</div>
                            <div style="font-size:13px; color:#888; height:18px;">${jiSibsin}</div>
                        `;
                        // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏: Ìï¥Îãπ blockIdxÏùò ÎÖÑÏö¥ ÎùºÏù∏Îßå Ï∂úÎ†•
                        if (blockIdx !== null) {
                            column.addEventListener('click', () => {
                                showYearunBlock(blockIdx);
                                // ÎÖÑÏö¥ ÌëúÍ∞Ä Í∞±Ïã†Îêú ÌõÑ, Ìï¥Îãπ ÎÖÑÏö¥ ÎùºÏù∏Ïùò Ï≤´ Î≤àÏß∏ Ïπ∏Ïùò ÎÖÑÍ∞ÑÏùÑ Ï∂îÏ∂úÌï¥ÏÑú ÏõîÏö¥ ÏûêÎèô Ï∂úÎ†•
                                setTimeout(() => {
                                    const yearunTable = document.getElementById('yearunTable');
                                    if (yearunTable) {
                                        const yearCells = yearunTable.querySelectorAll('div[style*="min-width: 80px"]');
                                        if (yearCells.length > 0) {
                                            // Ï≤´ Î≤àÏß∏ Ïπ∏(ÏôºÏ™Ω)Ïù¥ blockIdxÏóê Ìï¥ÎãπÌïòÎäî ÎÖÑÏö¥
                                            const firstCell = yearCells[0];
                                            const yearGanDiv = firstCell.querySelectorAll('div')[2];
                                            if (yearGanDiv) {
                                                const yearGan = yearGanDiv.textContent.trim();
                                                showMonthGanji(yearGan);
                                            }
                                        }
                                    }
                                }, 50);
                            });
                        }
                        daewoonContainer.appendChild(column);
                    });

                    // ÎÖÑÏö¥ ÌëúÎ•º Ìïú Ï§ÑÎßå Ï∂úÎ†•ÌïòÎäî Ìï®Ïàò
                    function showYearunBlock(blockIdx) {
                        // Í∏∞Ï°¥ ÎÖÑÏö¥ Ìëú/ÏõîÍ∞ÑÏßÄ Ìëú ÏÇ≠Ï†ú
                        const oldTable = document.getElementById('yearunTable');
                        if (oldTable) oldTable.remove();
                        const oldMonthTable = document.getElementById('monthganjiTable');
                        if (oldMonthTable) oldMonthTable.remove();
                        const yearunTable = document.createElement('div');
                        yearunTable.id = 'yearunTable';
                        yearunTable.style.display = 'flex';
                        yearunTable.style.flexDirection = 'column';
                        yearunTable.style.alignItems = 'center';
                        yearunTable.style.marginTop = '20px';
                        // ÎÖÑÏ£º(ÎÖÑÍ∞ÑÏßÄ) Í∏∞Ï§Ä
                        const yearGanji = data.year_ganji;
                        const gan = ['Áî≤','‰πô','‰∏ô','‰∏Å','Êàä','Â∑±','Â∫ö','Ëæõ','Â£¨','Áô∏'];
                        const ji = ['Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•'];
                        const ganStart = gan.indexOf(yearGanji[0]);
                        const jiStart = ji.indexOf(yearGanji[1]);
                        const birthYear = getDateTimeParts().year;
                        const cells = [];
                        for (let col = 0; col < 10; col++) {
                            const idx = blockIdx * 10 + col;
                            const age = baseAge + idx;
                            const year = birthYear + age - 1;
                            const yearGan = gan[(ganStart + age - 1) % 10];
                            const yearJi = ji[(jiStart + age - 1) % 12];
                            // Ïã≠Ïã† Í≥ÑÏÇ∞
                            let ganSibsin = '', jiSibsin = '';
                            if (data.day_ganji) {
                                const dayGan = data.day_ganji[0];
                                ganSibsin = getSibsin(dayGan, yearGan, true);
                                jiSibsin = getSibsin(dayGan, yearJi, false);
                            }
                            const cell = document.createElement('div');
                            cell.style.border = '1px solid #ccc';
                            cell.style.padding = '4px 8px';
                            cell.style.margin = '2px';
                            cell.style.fontSize = '13px';
                            cell.style.minWidth = '80px';
                            cell.style.textAlign = 'center';
                            cell.innerHTML = `
                                <div style="font-weight:bold; font-size:15px; margin-bottom:2px;">${year}</div>
                                <div style="font-size:13px; color:#888;">${ganSibsin}</div>
                                <div style="font-size:18px;">${yearGan}</div>
                                <div style="font-size:18px;">${yearJi}</div>
                                <div style="font-size:13px; color:#888;">${jiSibsin}</div>
                                <div style="font-size:13px; color:#666; margin-top:2px;">${age}</div>
                            `;
                            // ÏõîÏö¥ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                            cell.style.cursor = 'pointer';
                            cell.addEventListener('click', () => {
                                // ÌÅ¥Î¶≠Îêú Ïπ∏Ïùò Í∞ÑÏßÄ(ÎÖÑÍ∞Ñ) Ï∂îÏ∂ú
                                const clickedGanji = (yearGan + yearJi);
                                const clickedYearGan = clickedGanji[0];
                                showMonthGanji(clickedYearGan);
                            });
                            cells.push(cell);
                        }
                        // Ïò§Î•∏Ï™ΩÎ∂ÄÌÑ∞ ÏôºÏ™ΩÏúºÎ°ú Ï∂úÎ†•
                        const rowDiv = document.createElement('div');
                        rowDiv.style.display = 'flex';
                        rowDiv.style.justifyContent = 'center';
                        cells.reverse().forEach(cell => rowDiv.appendChild(cell));
                        yearunTable.appendChild(rowDiv);
                        daewoonContainer.parentNode.appendChild(yearunTable);
                    }

                    // ÏõîÍ∞ÑÏßÄ Ìëú Ï∂úÎ†• Ìï®Ïàò
                    function showMonthGanji(yearGan) {
                        // Í∏∞Ï°¥ ÏõîÏö¥ Ìëú ÏÇ≠Ï†ú
                        let oldMonthTable = document.getElementById('monthganjiTable');
                        if (oldMonthTable) oldMonthTable.remove();
                        const monthTable = document.createElement('div');
                        monthTable.id = 'monthganjiTable';
                        monthTable.style.display = 'flex';
                        monthTable.style.justifyContent = 'center';
                        monthTable.style.marginTop = '10px';
                        monthTable.style.background = '#f9f9e3'; // ÏûÑÏãú Î∞∞Í≤ΩÏÉâ(ÌôïÏù∏Ïö©)
                        const monthGanjiMap = {
                          'Áî≤': ['‰πô‰∏ë','‰∏ôÂØÖ','‰∏ÅÂçØ','ÊàäËæ∞','Â∑±Â∑≥','Â∫öÂçà','ËæõÊú™','Â£¨Áî≥','Áô∏ÈÖâ','Áî≤Êàå','‰πô‰∫•','‰∏ôÏûê'],
                          'Â∑±': ['‰πô‰∏ë','‰∏ôÂØÖ','‰∏ÅÂçØ','ÊàäËæ∞','Â∑±Â∑≥','Â∫öÂçà','ËæõÊú™','Â£¨Áî≥','Áô∏ÈÖâ','Áî≤Êàå','‰πô‰∫•','‰∏ôÏûê'],
                          '‰πô': ['‰∏Å‰∏ë','ÊàäÂØÖ','Â∑±ÂçØ','Â∫öËæ∞','ËæõÂ∑≥','Â£¨Âçà','Áô∏Êú™','Áî≤Áî≥','‰πôÈÖâ','‰∏ôÊàå','‰∏Å‰∫•','ÊàäÏûê'],
                          'Â∫ö': ['‰∏Å‰∏ë','ÊàäÂØÖ','Â∑±ÂçØ','Â∫öËæ∞','ËæõÂ∑≥','Â£¨Âçà','Áô∏Êú™','Áî≤Áî≥','‰πôÈÖâ','‰∏ôÊàå','‰∏Å‰∫•','ÊàäÏûê'],
                          '‰∏ô': ['Â∑±‰∏ë','Â∫öÂØÖ','ËæõÂçØ','Â£¨Ëæ∞','Áô∏Â∑≥','Áî≤Âçà','‰πôÊú™','‰∏ôÁî≥','‰∏ÅÈÖâ','ÊàäÊàå','Â∑±‰∫•','Â∫öÏûê'],
                          'Ëæõ': ['Â∑±‰∏ë','Â∫öÂØÖ','ËæõÂçØ','Â£¨Ëæ∞','Áô∏Â∑≥','Áî≤Âçà','‰πôÊú™','‰∏ôÁî≥','‰∏ÅÈÖâ','ÊàäÊàå','Â∑±‰∫•','Â∫öÏûê'],
                          '‰∏Å': ['Ëæõ‰∏ë','Â£¨ÂØÖ','Áô∏ÂçØ','Áî≤Ëæ∞','‰πôÂ∑≥','‰∏ôÂçà','‰∏ÅÊú™','ÊàäÁî≥','Â∑±ÈÖâ','Â∫öÊàå','Ëæõ‰∫•','Â£¨Ïûê'],
                          'Â£¨': ['Ëæõ‰∏ë','Â£¨ÂØÖ','Áô∏ÂçØ','Áî≤Ëæ∞','‰πôÂ∑≥','‰∏ôÂçà','‰∏ÅÊú™','ÊàäÁî≥','Â∑±ÈÖâ','Â∫öÊàå','Ëæõ‰∫•','Â£¨Ïûê'],
                          'Êàä': ['Áô∏‰∏ë','Áî≤ÂØÖ','‰πôÂçØ','‰∏ôËæ∞','‰∏ÅÂ∑≥','ÊàäÂçà','Â∑±Êú™','Â∫öÁî≥','ËæõÈÖâ','Â£¨Êàå','Áô∏‰∫•','Áî≤Ïûê'],
                          'Áô∏': ['Áô∏‰∏ë','Áî≤ÂØÖ','‰πôÂçØ','‰∏ôËæ∞','‰∏ÅÂ∑≥','ÊàäÂçà','Â∑±Êú™','Â∫öÁî≥','ËæõÈÖâ','Â£¨Êàå','Áô∏‰∫•','Áî≤Ïûê'],
                        };
                        const ganjiArr = monthGanjiMap[yearGan] || [];
                        const cells = [];
                        for (let i = 0; i < 12; i++) {
                            const ganji = ganjiArr[i] || '';
                            const gan = ganji[0] || '';
                            const ji = ganji[1] || '';
                            let ganSibsin = '', jiSibsin = '';
                            if (data.day_ganji) {
                                const dayGan = data.day_ganji[0];
                                ganSibsin = getSibsin(dayGan, gan, true);
                                jiSibsin = getSibsin(dayGan, ji, false);
                            }
                            const cell = document.createElement('div');
                            cell.style.border = '1px solid #aaa';
                            cell.style.padding = '4px 8px';
                            cell.style.margin = '2px';
                            cell.style.fontSize = '13px';
                            cell.style.minWidth = '60px';
                            cell.style.textAlign = 'center';
                            cell.style.overflow = 'hidden';
                            cell.style.textOverflow = 'ellipsis';
                            cell.style.whiteSpace = 'nowrap';
                            // Í∞ÑÏßÄÎ•º ÏÑ∏Î°úÎ°ú Ï∂úÎ†•
                            cell.innerHTML = `
                                <div style="font-weight:bold; font-size:15px; margin-bottom:2px;">${i+1}Ïõî</div>
                                <div style="font-size:13px; color:#888;">${ganSibsin}</div>
                                <div style="font-size:18px;">${gan}</div>
                                <div style="font-size:18px;">${ji}</div>
                                <div style="font-size:13px; color:#888;">${jiSibsin}</div>
                            `;
                            // Îã¨Î†• Î™®Îã¨ Ïù¥Î≤§Ìä∏
                            cell.style.cursor = 'pointer';
                            cell.addEventListener('click', () => {
                                showCalendarModal(daewoonContainer, i+1, year);
                            });
                            cells.push(cell);
                        }
                        // Ïò§Î•∏Ï™ΩÏóêÏÑú ÏôºÏ™ΩÏúºÎ°ú Ï∂úÎ†•
                        cells.reverse().forEach(cell => monthTable.appendChild(cell));
                        // ÎÖÑÏö¥ Ìëú Î∞îÎ°ú ÏïÑÎûòÏóê Ï∂îÍ∞Ä
                        const yearunTable = document.getElementById('yearunTable');
                        if (yearunTable && yearunTable.parentNode) {
                            yearunTable.parentNode.insertBefore(monthTable, yearunTable.nextSibling);
                        } else {
                            daewoonContainer.parentNode.appendChild(monthTable);
                        }
                    }

                    // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú ÌòÑÏû¨ ÎÇòÏù¥ÎåÄÏùò ÎÖÑÏö¥ ÎùºÏù∏Îßå Ï∂úÎ†•
                    const now = new Date();
                    const birthYear = getDateTimeParts().year;
                    const currentAge = now.getFullYear() - birthYear + 1;
                    let blockIdx = Math.floor((currentAge - baseAge) / 10);
                    if (blockIdx < 0) blockIdx = 0;
                    if (blockIdx > 9) blockIdx = 9;
                    showYearunBlock(blockIdx);

                    // ÌòÑÏû¨ ÎÖÑÎèÑÏùò ÏõîÏö¥ÏùÑ ÏûêÎèô Ï∂úÎ†•
                    (function showCurrentYearMonthUn() {
                        // ÎÖÑÏö¥ ÎùºÏù∏ÏóêÏÑú ÌòÑÏû¨ ÎÖÑÎèÑÏóê Ìï¥ÎãπÌïòÎäî Ïπ∏Ïùò ÎÖÑÍ∞Ñ Ï∂îÏ∂ú
                        const yearGanji = data.year_ganji;
                        const gan = ['Áî≤','‰πô','‰∏ô','‰∏Å','Êàä','Â∑±','Â∫ö','Ëæõ','Â£¨','Áô∏'];
                        const ji = ['Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•'];
                        const ganStart = gan.indexOf(yearGanji[0]);
                        const jiStart = ji.indexOf(yearGanji[1]);
                        const idx = currentAge - baseAge;
                        if (idx >= 0 && idx < 100) {
                            const yearGan = gan[(ganStart + currentAge - 1) % 10];
                            showMonthGanji(yearGan);
                        }
                    })();

                    // [Ï∂îÍ∞Ä] ÏÇ¨Ï£ºÏõêÍµ≠ Í∞±Ïã† ÌõÑ ÏõîÏö¥ ÌëúÎèÑ Ìï≠ÏÉÅ ÏµúÏã†ÏúºÎ°ú Í∞±Ïã†
                    setTimeout(() => {
                        const yearunTable = document.getElementById('yearunTable');
                        if (yearunTable) {
                            const yearCells = yearunTable.querySelectorAll('div[style*="min-width: 80px"]');
                            if (yearCells.length > 0) {
                                // yearCellsÎäî Ïôº‚ÜíÏò§ ÏàúÏÑúÏù¥ÎØÄÎ°ú, ÎßàÏßÄÎßâ Ïπ∏Ïù¥ ÏµúÏã†
                                const lastCell = yearCells[yearCells.length - 1];
                                // ÎÖÑÍ∞Ñ Ï∂îÏ∂ú (ÏúÑÏóêÏÑú 3Î≤àÏß∏ div)
                                const yearGanDiv = lastCell.querySelectorAll('div')[2];
                                if (yearGanDiv) {
                                    const yearGan = yearGanDiv.textContent.trim();
                                    showMonthGanji(yearGan);
                                }
                            }
                        }
                    }, 100);

                    // ÏµúÍ∑º ÏÇ¨Ï£º ÏûêÎèô Ï†ÄÏû• Ìï®Ïàò
                    addRecentSaju();

                    // ÏßÄÏû•Í∞Ñ Îß§Ìïë ÌÖåÏù¥Î∏î
                    const jijiToJijanggan = {
                        'Â≠ê': 'Â£¨ - Áô∏',
                        '‰∏ë': 'Áô∏ËæõÂ∑±',
                        'ÂØÖ': 'Êàä‰∏ôÁî≤',
                        'ÂçØ': 'Áî≤ - ‰πô',
                        'Ëæ∞': '‰πôÁô∏Êàä',
                        'Â∑≥': 'ÊàäÂ∫ö‰∏ô',
                        'Âçà': '‰∏ôÂ∑±‰∏Å',
                        'Êú™': '‰∏Å‰πôÂ∑±',
                        'Áî≥': 'ÊàäÂ£¨Â∫ö',
                        'ÈÖâ': 'Â∫ö - Ëæõ',
                        'Êàå': 'Ëæõ‰∏ÅÊàä',
                        '‰∫•': 'ÊàäÁî≤Â£¨'
                    };
                    // ÏßÄÏû•Í∞Ñ Ìï†Îãπ Ìï®Ïàò
                    function setJijanggan() {
                        const yearJi = (data.year_ganji && data.year_ganji[1]) ? data.year_ganji[1] : '';
                        const monthJi = (data.month_ganji && data.month_ganji[1]) ? data.month_ganji[1] : '';
                        const dayJi = (data.day_ganji && data.day_ganji[1]) ? data.day_ganji[1] : '';
                        const hourJi = (data.hour_ganji && data.hour_ganji[1]) ? data.hour_ganji[1] : '';
                        document.getElementById('yearJijanggan').textContent = jijiToJijanggan[yearJi] || '';
                        document.getElementById('monthJijanggan').textContent = jijiToJijanggan[monthJi] || '';
                        document.getElementById('dayJijanggan').textContent = jijiToJijanggan[dayJi] || '';
                        document.getElementById('hourJijanggan').textContent = jijiToJijanggan[hourJi] || '';
                    }
                    setJijanggan();

                    // 12Ïã†ÏÇ¥ Í∑úÏπô ÌÖåÏù¥Î∏î Î∞è Ìï®Ïàò
                    const shinsalTable = {
                        'Â∑≥ÈÖâ‰∏ë': ['Â∑≥','ÏßÄÏÇ¥','Âçà','ÎÖÑÏÇ¥','Êú™','ÏõîÏÇ¥','Áî≥','ÎßùÏã†','ÈÖâ','Ïû•ÏÑ±','Êàå','Î∞òÏïà','‰∫•','Ïó≠Îßà','Â≠ê','Ïú°Ìï¥','‰∏ë','ÌôîÍ∞ú','ÂØÖ','Í≤ÅÏÇ¥','ÂçØ','Ïû¨ÏÇ¥','Ëæ∞','Ï≤úÏÇ¥'],
                        'ÂØÖÂçàÊàå': ['ÂØÖ','ÏßÄÏÇ¥','ÂçØ','ÎÖÑÏÇ¥','Ëæ∞','ÏõîÏÇ¥','Â∑≥','ÎßùÏã†','Âçà','Ïû•ÏÑ±','Êú™','Î∞òÏïà','Áî≥','Ïó≠Îßà','ÈÖâ','Ïú°Ìï¥','Êàå','ÌôîÍ∞ú','‰∫•','Í≤ÅÏÇ¥','Â≠ê','Ïû¨ÏÇ¥','‰∏ë','Ï≤úÏÇ¥'],
                        '‰∫•ÂçØÊú™': ['‰∫•','ÏßÄÏÇ¥','Â≠ê','ÎÖÑÏÇ¥','‰∏ë','ÏõîÏÇ¥','ÂØÖ','ÎßùÏã†','ÂçØ','Ïû•ÏÑ±','Ëæ∞','Î∞òÏïà','Â∑≥','Ïó≠Îßà','Âçà','Ïú°Ìï¥','Êú™','ÌôîÍ∞ú','Áî≥','Í≤ÅÏÇ¥','ÈÖâ','Ïû¨ÏÇ¥','Êàå','Ï≤úÏÇ¥'],
                        'Áî≥Â≠êËæ∞': ['Áî≥','ÏßÄÏÇ¥','ÈÖâ','ÎÖÑÏÇ¥','Êàå','ÏõîÏÇ¥','‰∫•','ÎßùÏã†','Â≠ê','Ïû•ÏÑ±','‰∏ë','Î∞òÏïà','ÂØÖ','Ïó≠Îßà','ÂçØ','Ïú°Ìï¥','Ëæ∞','ÌôîÍ∞ú','Â∑≥','Í≤ÅÏÇ¥','Âçà','Ïû¨ÏÇ¥','Êú™','Ï≤úÏÇ¥']
                    };
                    function getShinsalMap(yearJi) {
                        let key = '';
                        if ('Â∑≥ÈÖâ‰∏ë'.includes(yearJi)) key = 'Â∑≥ÈÖâ‰∏ë';
                        else if ('ÂØÖÂçàÊàå'.includes(yearJi)) key = 'ÂØÖÂçàÊàå';
                        else if ('‰∫•ÂçØÊú™'.includes(yearJi)) key = '‰∫•ÂçØÊú™';
                        else if ('Áî≥Â≠êËæ∞'.includes(yearJi)) key = 'Áî≥Â≠êËæ∞';
                        else return {};
                        const arr = shinsalTable[key];
                        const map = {};
                        for (let i = 0; i < arr.length; i += 2) {
                            map[arr[i]] = arr[i+1];
                        }
                        return map;
                    }
                    function setShinsal() {
                        const yearJi = (data.year_ganji && data.year_ganji[1]) ? data.year_ganji[1] : '';
                        const monthJi = (data.month_ganji && data.month_ganji[1]) ? data.month_ganji[1] : '';
                        const dayJi = (data.day_ganji && data.day_ganji[1]) ? data.day_ganji[1] : '';
                        const hourJi = (data.hour_ganji && data.hour_ganji[1]) ? data.hour_ganji[1] : '';
                        const shinsalMap = getShinsalMap(yearJi);
                        document.getElementById('yearShinsal').textContent = shinsalMap[yearJi] || '';
                        document.getElementById('monthShinsal').textContent = shinsalMap[monthJi] || '';
                        document.getElementById('dayShinsal').textContent = shinsalMap[dayJi] || '';
                        document.getElementById('hourShinsal').textContent = shinsalMap[hourJi] || '';
                    }
                    setShinsal();

                    // 12Ïö¥ÏÑ± Í∑úÏπô ÌÖåÏù¥Î∏î
                    const unseongTable = {
                        'Áî≤': ['‰∫•','Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå'],
                        '‰πô': ['Âçà','Â∑≥','Ëæ∞','ÂçØ','ÂØÖ','‰∏ë','Â≠ê','‰∫•','Êàå','ÈÖâ','Áî≥','Êú™'],
                        '‰∏ô': ['ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•','Â≠ê','‰∏ë'],
                        '‰∏Å': ['ÈÖâ','Áî≥','Êú™','Âçà','Â∑≥','Ëæ∞','ÂçØ','ÂØÖ','‰∏ë','Â≠ê','‰∫•','Êàå'],
                        'Êàä': ['ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•','Â≠ê','‰∏ë'],
                        'Â∑±': ['ÈÖâ','Áî≥','Êú™','Âçà','Â∑≥','Ëæ∞','ÂçØ','ÂØÖ','‰∏ë','Â≠ê','‰∫•','Êàå'],
                        'Â∫ö': ['Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•','Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞'],
                        'Ëæõ': ['Â≠ê','‰∫•','Êàå','ÈÖâ','Áî≥','Êú™','Âçà','Â∑≥','Ëæ∞','ÂçØ','ÂØÖ','‰∏ë'],
                        'Â£¨': ['Áî≥','ÈÖâ','Êàå','‰∫•','Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™'],
                        'Áô∏': ['ÂçØ','ÂØÖ','‰∏ë','Â≠ê','‰∫•','Êàå','ÈÖâ','Áî≥','Êú™','Âçà','Â∑≥','Ëæ∞']
                    };
                    const unseongNames = ['Ïû•ÏÉù','Î™©Ïöï','Í¥ÄÎåÄ','Í±¥Î°ù','Ï†úÏôï','Ïá†','Î≥ë','ÏÇ¨','Î¨ò','Ï†à','ÌÉú','Ïñë'];

                    function getUnseong(dayGan, ji) {
                        if (!dayGan || !ji) return '';
                        const jiList = ['Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•'];
                        const jiIndex = jiList.indexOf(ji);
                        if (jiIndex === -1) return '';
                        const unseongOrder = unseongTable[dayGan];
                        if (!unseongOrder) return '';
                        const unseongIndex = unseongOrder.indexOf(ji);
                        if (unseongIndex === -1) return '';
                        return unseongNames[unseongIndex];
                    }

                    function setUnseong() {
                        const dayGan = (data.day_ganji && data.day_ganji[0]) ? data.day_ganji[0] : '';
                        const yearJi = (data.year_ganji && data.year_ganji[1]) ? data.year_ganji[1] : '';
                        const monthJi = (data.month_ganji && data.month_ganji[1]) ? data.month_ganji[1] : '';
                        const dayJi = (data.day_ganji && data.day_ganji[1]) ? data.day_ganji[1] : '';
                        const hourJi = (data.hour_ganji && data.hour_ganji[1]) ? data.hour_ganji[1] : '';
                        
                        document.getElementById('yearUnseong').textContent = getUnseong(dayGan, yearJi);
                        document.getElementById('monthUnseong').textContent = getUnseong(dayGan, monthJi);
                        document.getElementById('dayUnseong').textContent = getUnseong(dayGan, dayJi);
                        document.getElementById('hourUnseong').textContent = getUnseong(dayGan, hourJi);
                    }

                    // ÏÇ¨Ï£ºÏõêÍµ≠ Ï°∞Ìöå ÏÑ±Í≥µ Ïãú 12Ïö¥ÏÑ± ÏÑ§Ï†ï
                    if (response.ok) {
                        setShinsal();
                        setUnseong(); // 12Ïö¥ÏÑ± ÏÑ§Ï†ï Ï∂îÍ∞Ä
                        // ÏÇ¨Ï£º Ï†ïÎ≥¥ Î∞î Ï±ÑÏö∞Í∏∞ (Ïò§Î•ò Î∞©ÏßÄ: Í∞í ÏóÜÏùÑ Îïå Îπà Î¨∏ÏûêÏó¥, DOM Ï≤¥ÌÅ¨)
                        const infoSolarDate = document.getElementById('infoSolarDate');
                        const infoLunarDate = document.getElementById('infoLunarDate');
                        const infoAge = document.getElementById('infoAge');
                        const infoGender = document.getElementById('infoGender');

                        if (infoSolarDate) infoSolarDate.textContent = 'ÏñëÎ†•: ' + (typeof data.solar_date === 'string' ? data.solar_date : '');
                        if (infoLunarDate) infoLunarDate.textContent = 'ÏùåÎ†•: ' + (typeof data.lunar_date === 'string' ? data.lunar_date : '');

                        // ÎÇòÏù¥ Í≥ÑÏÇ∞ (solar_dateÍ∞Ä 'YYYYÎÖÑ MMÏõî DDÏùº' ÌòïÏãùÏù¥ ÏïÑÎãê ÎïåÎèÑ ÎåÄÎπÑ)
                        let age = '';
                        if (typeof data.solar_date === 'string' && /^\d{4}/.test(data.solar_date)) {
                            const birthYear = parseInt(data.solar_date.slice(0,4), 10);
                            if (!isNaN(birthYear)) {
                                const now = new Date();
                                age = now.getFullYear() - birthYear + 1;
                            }
                        }
                        if (infoAge) infoAge.textContent = 'ÎÇòÏù¥: ' + (age ? age : '');

                        // ÏÑ±Î≥Ñ
                        let genderText = '';
                        if (typeof data.gender === 'string') {
                            genderText = data.gender === 'M' ? 'ÎÇ®' : (data.gender === 'F' ? 'Ïó¨' : '');
                        } else if (document.getElementById('gender')) {
                            // fallback: ÌòÑÏû¨ ÏûÖÎ†•Í∞í
                            const gval = document.getElementById('gender').value;
                            genderText = gval === 'M' ? 'ÎÇ®' : (gval === 'F' ? 'Ïó¨' : '');
                        }
                        if (infoGender) infoGender.textContent = 'ÏÑ±Î≥Ñ: ' + genderText;
                    }
                } else {
                    alert(data && data.error ? data.error : 'Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    // info bar Ï¥àÍ∏∞Ìôî
                    const infoSolarDate = document.getElementById('infoSolarDate');
                    const infoLunarDate = document.getElementById('infoLunarDate');
                    const infoAge = document.getElementById('infoAge');
                    const infoGender = document.getElementById('infoGender');
                    if (infoSolarDate) infoSolarDate.textContent = '';
                    if (infoLunarDate) infoLunarDate.textContent = '';
                    if (infoAge) infoAge.textContent = '';
                    if (infoGender) infoGender.textContent = '';
                }
            } catch (error) {
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                console.error('Error:', error);
            }
        });

        document.getElementById('unknownHour').addEventListener('change', function() {
            const hourInput = document.getElementById('hour');
            const minuteInput = document.getElementById('minute');
            if (this.checked) {
                hourInput.value = 0;
                minuteInput.value = 0;
                hourInput.disabled = true;
                minuteInput.disabled = true;
            } else {
                // Ïãú Î™®Î¶Ñ Ìï¥Ï†ú Ïãú ÌòÑÏû¨ ÏãúÍ∞Ñ ÏûêÎèôÏûÖÎ†•
                const now = new Date();
                hourInput.value = now.getHours();
                minuteInput.value = now.getMinutes();
                hourInput.disabled = false;
                minuteInput.disabled = false;
            }
        });

        // Îã¨Î†• Î™®Îã¨ Ìï®Ïàò
        function showCalendarModal(parentElem, month, year) {
            // Í∏∞Ï°¥ Î™®Îã¨ ÏÇ≠Ï†ú
            let oldModal = document.getElementById('calendarModal');
            if (oldModal) oldModal.remove();
            // Îã¨Î†• ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.id = 'calendarModal';
            modal.style.position = 'fixed';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.3)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '9999';
            const calBox = document.createElement('div');
            calBox.style.background = '#fff';
            calBox.style.padding = '20px';
            calBox.style.borderRadius = '10px';
            calBox.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            calBox.style.minWidth = '320px';
            // Îã¨Î†• Ìó§Îçî
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '10px';
            header.innerHTML = `<b>${year}ÎÖÑ ${month}Ïõî</b>`;
            // Îã´Í∏∞ Î≤ÑÌäº
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Îã´Í∏∞';
            closeBtn.style.marginLeft = '10px';
            closeBtn.onclick = () => modal.remove();
            header.appendChild(closeBtn);
            calBox.appendChild(header);
            // Îã¨Î†• Ìëú
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            const days = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
            let tr = document.createElement('tr');
            days.forEach(d => {
                const th = document.createElement('th');
                th.textContent = d;
                th.style.border = '1px solid #ccc';
                th.style.padding = '2px';
                tr.appendChild(th);
            });
            table.appendChild(tr);
            // ÎÇ†Ïßú Ï±ÑÏö∞Í∏∞
            const firstDay = new Date(year, month-1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();
            tr = document.createElement('tr');
            for (let i = 0; i < firstDay; i++) {
                const td = document.createElement('td');
                td.innerHTML = '&nbsp;';
                tr.appendChild(td);
            }
            for (let d = 1; d <= lastDate; d++) {
                if ((tr.children.length) % 7 === 0 && d !== 1) {
                    table.appendChild(tr);
                    tr = document.createElement('tr');
                }
                const td = document.createElement('td');
                // 60Í∞ëÏûê Í≥ÑÏÇ∞
                const ganzhi60 = [
                    'Áî≤Â≠ê','‰πô‰∏ë','‰∏ôÂØÖ','‰∏ÅÂçØ','ÊàäËæ∞','Â∑±Â∑≥','Â∫öÂçà','ËæõÊú™','Â£¨Áî≥','Áô∏ÈÖâ',
                    'Áî≤Êàå','‰πô‰∫•','‰∏ôÂ≠ê','‰∏Å‰∏ë','ÊàäÂØÖ','Â∑±ÂçØ','Â∫öËæ∞','ËæõÂ∑≥','Â£¨Âçà','Áô∏Êú™',
                    'Áî≤Áî≥','‰πôÈÖâ','‰∏ôÊàå','‰∏Å‰∫•','ÊàäÂ≠ê','Â∑±‰∏ë','Â∫öÂØÖ','ËæõÂçØ','Â£¨Ëæ∞','Áô∏Â∑≥',
                    'Áî≤Âçà','‰πôÊú™','‰∏ôÁî≥','‰∏ÅÈÖâ','ÊàäÊàå','Â∑±‰∫•','Â∫öÂ≠ê','Ëæõ‰∏ë','Â£¨ÂØÖ','Áô∏ÂçØ',
                    'Áî≤Ëæ∞','‰πôÂ∑≥','‰∏ôÂçà','‰∏ÅÊú™','ÊàäÁî≥','Â∑±ÈÖâ','Â∫öÊàå','Ëæõ‰∫•','Â£¨Â≠ê','Áô∏‰∏ë',
                    'Áî≤ÂØÖ','‰πôÂçØ','‰∏ôËæ∞','‰∏ÅÂ∑≥','ÊàäÂçà','Â∑±Êú™','Â∫öÁî≥','ËæõÈÖâ','Â£¨Êàå','Áô∏‰∫•'
                ];
                const baseDate = new Date(1984, 1, 2); // Ïõî 0-indexed
                const thisDate = new Date(year, month-1, d);
                const diffDays = Math.floor((thisDate - baseDate) / (1000*60*60*24));
                let ganzhi = '';
                if (diffDays >= 0) {
                    ganzhi = ganzhi60[diffDays % 60];
                } else {
                    ganzhi = ganzhi60[(60 + (diffDays % 60)) % 60];
                }
                const ganzhiVertical = ganzhi.split('').join('<br>');
                td.innerHTML = `<div>${d}</div><div style='font-size:11px;color:#888;'>${ganzhiVertical}</div>`;
                td.style.border = '1px solid #ccc';
                td.style.padding = '2px';
                // ÎÇ†Ïßú ÌÅ¥Î¶≠ Ïãú ÏûÖÎ†•ÎûÄÏóê Î∞òÏòÅÌïòÍ≥† Îã¨Î†• Îã´Í∏∞ Î∞è ÏÇ¨Ï£ºÏõêÍµ≠ ÏûêÎèô Ï°∞Ìöå
                td.style.cursor = 'pointer';
                td.onclick = () => {
                    // Í∏∞Ï°¥ datetimeInput Í∞íÏóêÏÑú Ïãú/Î∂ÑÎßå Ï∂îÏ∂ú
                    const datetimeInput = document.getElementById('datetimeInput');
                    let val = datetimeInput.value.trim();
                    let hour = '00', minute = '00';
                    if (val.length === 12) {
                        hour = val.slice(8, 10);
                        minute = val.slice(10, 12);
                    }
                    // ÏÉà ÎÇ†ÏßúÎ°ú datetimeInput Í∞í Í∞±Ïã†
                    const mm = month.toString().padStart(2, '0');
                    const dd = d.toString().padStart(2, '0');
                    datetimeInput.value = `${year}${mm}${dd}${hour}${minute}`;
                    modal.remove();
                    setTimeout(() => {
                        document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
                    }, 50);
                };
                tr.appendChild(td);
            }
            while (tr.children.length < 7) {
                const td = document.createElement('td');
                td.innerHTML = '&nbsp;';
                tr.appendChild(td);
            }
            table.appendChild(tr);
            calBox.appendChild(table);
            modal.appendChild(calBox);
            document.body.appendChild(modal);
        }

        // ÏÇ¨Ï£º Ï†ÄÏû•/Ï°∞Ìöå Í∏∞Îä•
        // Ï†ÄÏû• Î≤ÑÌäº ÌÅ¥Î¶≠
        document.getElementById('saveSajuBtn').onclick = function() {
            document.getElementById('saveMemo').value = '';
            document.getElementById('saveModal').style.display = 'flex';
        };
        // Ï†ÄÏû• Î™®Îã¨ Ï∑®ÏÜå
        document.getElementById('saveModalCancel').onclick = function() {
            document.getElementById('saveModal').style.display = 'none';
        };
        // Ï†ÄÏû• Î™®Îã¨ Ï†ÄÏû•
        document.getElementById('saveModalOk').onclick = function() {
            const memo = document.getElementById('saveMemo').value.trim();
            if (memo.length === 0) {
                alert('Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            // ÌòÑÏû¨ ÏûÖÎ†•Í∞í Ï†ÄÏû•
            const sajuData = {
                memo,
                savedAt: new Date().toISOString(),
                gender: document.getElementById('gender').value,
                calendarType: document.getElementById('calendarType').value,
                datetime: document.getElementById('datetimeInput').value,
                unknownHour: document.getElementById('unknownHour').checked
            };
            let list = JSON.parse(localStorage.getItem('sajuList') || '[]');
            list.unshift(sajuData); // ÏµúÏã†Ïù¥ ÏúÑÎ°ú
            localStorage.setItem('sajuList', JSON.stringify(list));
            document.getElementById('saveModal').style.display = 'none';
            alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
        };
        // Ï°∞Ìöå Î≤ÑÌäº ÌÅ¥Î¶≠
        document.getElementById('loadSajuBtn').onclick = function() {
            const list = JSON.parse(localStorage.getItem('sajuList') || '[]');
            const loadList = document.getElementById('loadList');
            loadList.innerHTML = '';
            if (list.length === 0) {
                loadList.innerHTML = '<div style="color:#888;">Ï†ÄÏû•Îêú ÏÇ¨Ï£ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            } else {
                list.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.style.border = '1px solid #ccc';
                    div.style.borderRadius = '6px';
                    div.style.padding = '8px';
                    div.style.marginBottom = '6px';
                    div.style.cursor = 'pointer';
                    div.style.background = '#f8f9fa';
                    div.innerHTML = `<b>${item.memo}</b> <span style="color:#888;font-size:12px;">(${item.savedAt.slice(0,16).replace('T',' ')})</span><br>
                        <span style="font-size:12px;">${item.gender==='M'?'ÎÇ®':'Ïó¨'}, ${item.calendarType==='lunar'?'ÏùåÎ†•':'ÏñëÎ†•'}, ${item.datetime}, ${item.unknownHour?'ÏãúÎ™®Î¶Ñ':''}</span>`;
                    div.onclick = function() {
                        // ÏûÖÎ†•Í∞í Î∞òÏòÅ
                        document.getElementById('gender').value = item.gender;
                        document.getElementById('calendarType').value = item.calendarType;
                        document.getElementById('datetimeInput').value = item.datetime;
                        document.getElementById('unknownHour').checked = item.unknownHour;
                        // ÏãúÎ™®Î¶Ñ Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
                        document.getElementById('unknownHour').dispatchEvent(new Event('change'));
                        document.getElementById('loadModal').style.display = 'none';
                        setTimeout(() => {
                            document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
                        }, 100);
                    };
                    loadList.appendChild(div);
                });
            }
            document.getElementById('loadModal').style.display = 'flex';
        };
        // Ï°∞Ìöå Î™®Îã¨ Îã´Í∏∞
        document.getElementById('loadModalClose').onclick = function() {
            document.getElementById('loadModal').style.display = 'none';
        };

        // ÏµúÍ∑º Î≤ÑÌäº/Î™®Îã¨ Í∏∞Îä•
        document.getElementById('recentSajuBtn').onclick = function() {
            const list = JSON.parse(localStorage.getItem('recentSajuList') || '[]');
            const recentList = document.getElementById('recentList');
            recentList.innerHTML = '';
            if (list.length === 0) {
                recentList.innerHTML = '<div style="color:#888;">ÏµúÍ∑º Ï°∞ÌöåÌïú ÏÇ¨Ï£ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            } else {
                list.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.style.border = '1px solid #ccc';
                    div.style.borderRadius = '6px';
                    div.style.padding = '8px';
                    div.style.marginBottom = '6px';
                    div.style.cursor = 'pointer';
                    div.style.background = '#f8f9fa';
                    div.innerHTML = `<span style="color:#888;font-size:12px;">${item.savedAt.slice(0,16).replace('T',' ')}</span><br>
                        <span style="font-size:12px;">${item.gender==='M'?'ÎÇ®':'Ïó¨'}, ${item.calendarType==='lunar'?'ÏùåÎ†•':'ÏñëÎ†•'}, ${item.datetime}, ${item.unknownHour?'ÏãúÎ™®Î¶Ñ':''}</span>`;
                    div.onclick = function() {
                        document.getElementById('gender').value = item.gender;
                        document.getElementById('calendarType').value = item.calendarType;
                        document.getElementById('datetimeInput').value = item.datetime;
                        document.getElementById('unknownHour').checked = item.unknownHour;
                        document.getElementById('unknownHour').dispatchEvent(new Event('change'));
                        document.getElementById('recentModal').style.display = 'none';
                        setTimeout(() => {
                            document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
                        }, 100);
                    };
                    recentList.appendChild(div);
                });
            }
            document.getElementById('recentModal').style.display = 'flex';
        };
        document.getElementById('recentModalClose').onclick = function() {
            document.getElementById('recentModal').style.display = 'none';
        };

        // ÏµúÍ∑º ÏÇ¨Ï£º ÏûêÎèô Ï†ÄÏû• Ìï®Ïàò
        function addRecentSaju() {
            const recent = {
                gender: document.getElementById('gender').value,
                calendarType: document.getElementById('calendarType').value,
                datetime: document.getElementById('datetimeInput').value,
                unknownHour: document.getElementById('unknownHour').checked,
                savedAt: new Date().toISOString()
            };
            let list = JSON.parse(localStorage.getItem('recentSajuList') || '[]');
            // Ï§ëÎ≥µ Ï†úÍ±∞(ÎèôÏùº ÏûÖÎ†•Í∞í)
            list = list.filter(item =>
                !(item.gender === recent.gender &&
                  item.calendarType === recent.calendarType &&
                  item.datetime === recent.datetime &&
                  item.unknownHour === recent.unknownHour)
            );
            list.unshift(recent);
            if (list.length > 50) list = list.slice(0, 50);
            localStorage.setItem('recentSajuList', JSON.stringify(list));
        }

        // Îã¨Î†• Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌòÑÏû¨ ÏõîÏùò Îã¨Î†• Î™®Îã¨ ÎùÑÏö∞Í∏∞
        document.getElementById('calendarBtn').onclick = function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const daewoonContainer = document.getElementById('daewoonContainer');
            showCalendarModal(daewoonContainer, month, year);
        };
    </script>
</body>
</html> 