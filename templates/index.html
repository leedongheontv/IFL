<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì£¼ì›êµ­ ì¡°íšŒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .result-box {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: none;
        }
        .ganji-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-bottom: 20px;
            direction: rtl;
        }
        .ganji-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
            direction: ltr;
        }
        .ganji-box {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin: 5px;
            font-size: 24px;
            background-color: #f8f9fa;
            writing-mode: vertical-rl;
            text-orientation: upright;
        }
        .ganji-label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #666;
        }
        .daewoon-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-top: 20px;
            direction: ltr;
        }
        .daewoon-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
        }
        .daewoon-box {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            border: 2px solid #28a745;
            border-radius: 5px;
            margin: 5px;
            font-size: 24px;
            background-color: #f8f9fa;
            writing-mode: vertical-rl;
            text-orientation: upright;
        }
        .daewoon-count {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ìƒë‹¨: ì œëª© + ë²„íŠ¼ ê°€ë¡œ ë°°ì¹˜ -->
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div style="font-size:1.7rem; font-weight:bold; color:#d32f2f; letter-spacing:-1px; white-space:nowrap;">
                IFL ë§Œì„¸ë ¥
            </div>
            <div>
                <button id="saveSajuBtn" class="btn btn-outline-secondary btn-sm" title="ì‚¬ì£¼ ì €ì¥">ğŸ’¾ ì €ì¥</button>
                <button id="loadSajuBtn" class="btn btn-outline-secondary btn-sm ms-2" title="ì €ì¥ëœ ì‚¬ì£¼ ì¡°íšŒ">ğŸ“‚ ì¡°íšŒ</button>
                <button id="recentSajuBtn" class="btn btn-outline-secondary btn-sm ms-2" title="ìµœê·¼ ì¡°íšŒ">ğŸ•‘ ìµœê·¼</button>
                <button id="calendarBtn" class="btn btn-outline-secondary btn-sm ms-2" title="ë‹¬ë ¥ ë³´ê¸°">ğŸ“… ë‹¬ë ¥</button>
            </div>
        </div>

        <!-- ì…ë ¥ í¼: ë¼ë²¨ ì‚­ì œ, í•œ ì¤„ë¡œ ì •ë ¬, ë²„íŠ¼ëª… 'ì¡°íšŒ'ë¡œ ë³€ê²½ -->
        <form id="sajuForm" class="mb-4">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <select class="form-control form-control-sm" id="gender" required style="min-width:60px;">
                        <option value="M">ë‚¨ì</option>
                        <option value="F" selected>ì—¬ì</option>
                    </select>
                </div>
                <div class="col-auto">
                    <select class="form-control form-control-sm" id="calendarType" required style="min-width:60px;">
                        <option value="solar">ì–‘ë ¥</option>
                        <option value="lunar">ìŒë ¥</option>
                    </select>
                </div>
                <div class="col-auto">
                    <input type="text" class="form-control form-control-sm" id="datetimeInput" maxlength="12" placeholder="YYYYMMDDHHmm" required style="width:120px;">
                </div>
                <div class="col-auto">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="unknownHour">
                        <label class="form-check-label" for="unknownHour" style="font-size:0.95em;">ì‹œ ëª¨ë¦„</label>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary btn-sm">ì¡°íšŒ</button>
                </div>
            </div>
        </form>

        <!-- ì €ì¥ ë©”ëª¨ ì…ë ¥ ëª¨ë‹¬ -->
        <div id="saveModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
          <div style="background:#fff; padding:20px; border-radius:10px; min-width:300px;">
            <div>ì´ë¦„ <input id="saveMemo" maxlength="30" style="width:200px;"></div>
            <div class="mt-2 text-end">
              <button id="saveModalOk" class="btn btn-primary btn-sm">ì €ì¥</button>
              <button id="saveModalCancel" class="btn btn-secondary btn-sm">ì·¨ì†Œ</button>
            </div>
          </div>
        </div>
        <!-- ì €ì¥ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
        <div id="loadModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
          <div style="background:#fff; padding:20px; border-radius:10px; min-width:350px; max-height:80vh; overflow-y:auto;">
            <div style="font-weight:bold; margin-bottom:10px;">ì €ì¥ëœ ì‚¬ì£¼</div>
            <div id="loadList"></div>
            <div class="mt-2 text-end">
              <button id="loadModalClose" class="btn btn-secondary btn-sm">ë‹«ê¸°</button>
            </div>
          </div>
        </div>
        <!-- ìµœê·¼ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
        <div id="recentModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
          <div style="background:#fff; padding:20px; border-radius:10px; min-width:350px; max-height:80vh; overflow-y:auto;">
            <div style="font-weight:bold; margin-bottom:10px;">ìµœê·¼ ì¡°íšŒí•œ ì‚¬ì£¼</div>
            <div id="recentList"></div>
            <div class="mt-2 text-end">
              <button id="recentModalClose" class="btn btn-secondary btn-sm">ë‹«ê¸°</button>
            </div>
          </div>
        </div>

        <div id="result" class="result-box">           
            <!-- ì‚¬ì£¼ì›êµ­ ì •ë³´ ìœ—ì¤„ì— í…ìŠ¤íŠ¸ ì •ë³´ ì¶”ê°€ -->
            <div id="sajuInfoBar" style="text-align:center; font-size:1.05em; margin-bottom:10px; color:#333; font-weight:500;">
                <span id="infoSolarDate"></span>
                <span id="infoLunarDate" style="margin-left:10px;"></span>
                <span id="infoAge" style="margin-left:10px;"></span>
                <span id="infoGender" style="margin-left:10px;"></span>
            </div>
            <div class="ganji-container">
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="yearGanSibsin"></span> </div>
                    <div class="ganji-box" id="yearGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="yearJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="yearJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="yearShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="yearUnseong"></span> </div>
                </div>
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="monthGanSibsin"></span> </div>
                    <div class="ganji-box" id="monthGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="monthJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="monthJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="monthShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="monthUnseong"></span> </div>
                </div>
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="dayGanSibsin"></span> </div>
                    <div class="ganji-box" id="dayGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="dayJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="dayJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="dayShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="dayUnseong"></span> </div>
                </div>
                <div class="ganji-column">
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="hourGanSibsin"></span> </div>
                    <div class="ganji-box" id="hourGanji"></div>
                    <div style="font-size:13px; color:#888; height:18px;"> <span id="hourJiSibsin"></span> </div>
                    <div style="font-size:12px; color:#666; height:18px;"> <span id="hourJijanggan"></span> </div>
                    <div style="font-size:12px; color:#b36; height:18px;"> <span id="hourShinsal"></span> </div>
                    <div style="font-size:12px; color:#36b; height:18px;"> <span id="hourUnseong"></span> </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="daewoon-container" id="daewoonContainer">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì‹­ì‹  ê³„ì‚° í•¨ìˆ˜ (ì „ì—­ ì„ ì–¸)
        function getSibsin(dayGan, target, isGan) {
            if (!dayGan || !target || target.length !== 1) return '';
            const sibsinGan = {
                'ç”²': ['ë¹„ê²¬','ê²ì¬','ì‹ì‹ ','ìƒê´€','í¸ì¬','ì •ì¬','í¸ê´€','ì •ê´€','í¸ì¸','ì •ì¸'],
                'ä¹™': ['ê²ì¬','ë¹„ê²¬','ìƒê´€','ì‹ì‹ ','ì •ì¬','í¸ì¬','ì •ê´€','í¸ê´€','ì •ì¸','í¸ì¸'],
                'ä¸™': ['í¸ì¸','ì •ì¸','ë¹„ê²¬','ê²ì¬','ì‹ì‹ ','ìƒê´€','í¸ì¬','ì •ì¬','í¸ê´€','ì •ê´€'],
                'ä¸': ['ì •ì¸','í¸ì¸','ê²ì¬','ë¹„ê²¬','ìƒê´€','ì‹ì‹ ','ì •ì¬','í¸ì¬','ì •ê´€','í¸ê´€'],
                'æˆŠ': ['í¸ê´€','ì •ê´€','í¸ì¸','ì •ì¸','ë¹„ê²¬','ê²ì¬','ì‹ì‹ ','ìƒê´€','í¸ì¬','ì •ì¬'],
                'å·±': ['ì •ê´€','í¸ê´€','ì •ì¸','í¸ì¸','ê²ì¬','ë¹„ê²¬','ìƒê´€','ì‹ì‹ ','ì •ì¬','í¸ì¬'],
                'åºš': ['í¸ì¬','ì •ì¬','í¸ê´€','ì •ê´€','í¸ì¸','ì •ì¸','ë¹„ê²¬','ê²ì¬','ì‹ì‹ ','ìƒê´€'],
                'è¾›': ['ì •ì¬','í¸ì¬','ì •ê´€','í¸ê´€','ì •ì¸','í¸ì¸','ê²ì¬','ë¹„ê²¬','ìƒê´€','ì‹ì‹ '],
                'å£¬': ['ì‹ì‹ ','ìƒê´€','í¸ì¬','ì •ì¬','í¸ê´€','ì •ê´€','í¸ì¸','ì •ì¸','ë¹„ê²¬','ê²ì¬'],
                'ç™¸': ['ìƒê´€','ì‹ì‹ ','ì •ì¬','í¸ì¬','ì •ê´€','í¸ê´€','ì •ì¸','í¸ì¸','ê²ì¬','ë¹„ê²¬'],
            };
            const sibsinJi = {
                'ç”²': ['ì •ì¸','ì •ì¬','ë¹„ê²¬','ê²ì¬','í¸ì¬','ì‹ì‹ ','ìƒê´€','ì •ì¬','í¸ê´€','ì •ê´€','í¸ì¬','í¸ì¸'],
                'ä¹™': ['í¸ì¸','í¸ì¬','ê²ì¬','ë¹„ê²¬','ì •ì¬','ìƒê´€','ì‹ì‹ ','í¸ì¬','ì •ê´€','í¸ê´€','ì •ì¬','ì •ì¸'],
                'ä¸™': ['ì •ê´€','ìƒê´€','í¸ì¸','ì •ì¸','ì‹ì‹ ','ë¹„ê²¬','ê²ì¬','ìƒê´€','í¸ì¬','ì •ì¬','ì‹ì‹ ','í¸ê´€'],
                'ä¸': ['í¸ê´€','ì‹ì‹ ','ì •ì¸','í¸ì¸','ìƒê´€','ê²ì¬','ë¹„ê²¬','ì‹ì‹ ','ì •ì¬','í¸ì¬','ìƒê´€','ì •ê´€'],
                'æˆŠ': ['ì •ì¬','ê²ì¬','í¸ê´€','ì •ê´€','ë¹„ê²¬','í¸ì¸','ì •ì¸','ê²ì¬','ì‹ì‹ ','ìƒê´€','ë¹„ê²¬','í¸ì¬'],
                'å·±': ['í¸ì¬','ë¹„ê²¬','í¸ê´€','ì •ê´€','ê²ì¬','ì •ì¸','í¸ì¸','ë¹„ê²¬','ìƒê´€','ì‹ì‹ ','ê²ì¬','ì •ì¬'],
                'åºš': ['ìƒê´€','ì •ì¸','í¸ì¬','ì •ì¬','í¸ì¸','í¸ê´€','ì •ê´€','ì •ì¸','ë¹„ê²¬','ê²ì¬','í¸ì¸','ì‹ì‹ '],
                'è¾›': ['ì‹ì‹ ','í¸ì¸','ì •ì¬','í¸ì¬','ì •ì¸','ì •ê´€','í¸ê´€','í¸ì¸','ê²ì¬','ë¹„ê²¬','ì •ì¸','ìƒê´€'],
                'å£¬': ['ê²ì¬','ì •ê´€','ì‹ì‹ ','ìƒê´€','í¸ê´€','í¸ì¬','ì •ì¬','ì •ê´€','í¸ì¸','ì •ì¸','í¸ê´€','ë¹„ê²¬'],
                'ç™¸': ['ë¹„ê²¬','í¸ê´€','ìƒê´€','ì‹ì‹ ','ì •ê´€','ì •ì¬','í¸ì¬','í¸ê´€','ì •ì¸','í¸ì¸','ì •ê´€','ê²ì¬'],
            };
            const ganList = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
            const jiList = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
            if (isGan) {
                if (!target || ganList.indexOf(target) === -1) return '';
                return sibsinGan[dayGan][ganList.indexOf(target)];
            } else {
                if (!target || jiList.indexOf(target) === -1) return '';
                return sibsinJi[dayGan][jiList.indexOf(target)];
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ datetimeInputì— í˜„ì¬ ë‚ ì§œ/ì‹œê°„ ìë™ ì…ë ¥
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const yyyy = now.getFullYear().toString();
            const mm = (now.getMonth() + 1).toString().padStart(2, '0');
            const dd = now.getDate().toString().padStart(2, '0');
            const hh = now.getHours().toString().padStart(2, '0');
            const min = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('datetimeInput').value = `${yyyy}${mm}${dd}${hh}${min}`;
            // í¼ ìë™ ì œì¶œ
            setTimeout(() => {
                document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
            }, 100); // ì•½ê°„ì˜ ë”œë ˆì´ë¡œ ë Œë”ë§ ë³´ì¥
        });

        // datetimeInputì—ì„œ ë…„,ì›”,ì¼,ì‹œ,ë¶„ ì¶”ì¶œ í•¨ìˆ˜
        function getDateTimeParts() {
            const datetimeStr = document.getElementById('datetimeInput').value.trim();
            return {
                year: parseInt(datetimeStr.slice(0, 4), 10),
                month: parseInt(datetimeStr.slice(4, 6), 10),
                day: parseInt(datetimeStr.slice(6, 8), 10),
                hour: parseInt(datetimeStr.slice(8, 10), 10),
                minute: parseInt(datetimeStr.slice(10, 12), 10)
            };
        }

        document.getElementById('sajuForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const unknown_hour = document.getElementById('unknownHour').checked;
            const datetimeStr = document.getElementById('datetimeInput').value.trim();

            if (unknown_hour) {
                // ì‹œ ëª¨ë¦„: 8ìë¦¬(YYYYMMDD)ë§Œ í—ˆìš©
                if (!/^[0-9]{8}$/.test(datetimeStr)) {
                    alert('ì…ë ¥ì˜¤ë¥˜: ì‹œ ëª¨ë¦„ì¼ ë•ŒëŠ” 8ìë¦¬(YYYYMMDD)ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
            } else {
                // ì‹œ ëª¨ë¦„ í•´ì œ: 12ìë¦¬(YYYYMMDDHHmm)ë§Œ í—ˆìš©
                if (!/^[0-9]{12}$/.test(datetimeStr)) {
                    alert('ì…ë ¥ì˜¤ë¥˜: 12ìë¦¬(YYYYMMDDHHmm)ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
            }

            const year = parseInt(datetimeStr.slice(0, 4), 10);
            const month = parseInt(datetimeStr.slice(4, 6), 10);
            const day = parseInt(datetimeStr.slice(6, 8), 10);
            let hour = 0, minute = 0;
            if (!unknown_hour) {
                hour = parseInt(datetimeStr.slice(8, 10), 10);
                minute = parseInt(datetimeStr.slice(10, 12), 10);
            }

            const gender = document.getElementById('gender').value;
            const is_lunar = document.getElementById('calendarType').value === 'lunar';

            try {
                const response = await fetch('/get_saju', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ year, month, day, hour, minute, gender, is_lunar, unknown_hour }),
                });

                const data = await response.json();
                
                if (response.ok && data && typeof data === 'object' && !data.error) {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('yearGanji').textContent = data.year_ganji;
                    document.getElementById('monthGanji').textContent = data.month_ganji;
                    document.getElementById('dayGanji').textContent = data.day_ganji;
                    document.getElementById('hourGanji').textContent = data.hour_ganji;
                    document.getElementById('yearGanSibsin').textContent = data.sibsin.year_gan;
                    document.getElementById('yearJiSibsin').textContent = data.sibsin.year_ji;
                    document.getElementById('monthGanSibsin').textContent = data.sibsin.month_gan;
                    document.getElementById('monthJiSibsin').textContent = data.sibsin.month_ji;
                    document.getElementById('dayGanSibsin').textContent = data.sibsin.day_gan;
                    document.getElementById('dayJiSibsin').textContent = data.sibsin.day_ji;
                    document.getElementById('hourGanSibsin').textContent = (data.sibsin && data.sibsin.hour_gan) ? data.sibsin.hour_gan : '';
                    document.getElementById('hourJiSibsin').textContent = (data.sibsin && data.sibsin.hour_ji) ? data.sibsin.hour_ji : '';

                    console.log('sibsin:', data.sibsin);

                    // ëŒ€ìš´ìˆ˜ í‘œì‹œ
                    const daewoonContainer = document.getElementById('daewoonContainer');
                    daewoonContainer.innerHTML = '';
                    const total = data.daewoon.length;
                    const baseAge = data.daewoon[0].daewoon_count;
                    const reversed = data.daewoon.slice().reverse();
                    // ëŒ€ìš´ ë¼ì¸ ìƒì„± ë° í´ë¦­ ì´ë²¤íŠ¸ ë¶€ì—¬
                    reversed.forEach((daewoon, idx) => {
                        const column = document.createElement('div');
                        column.className = 'daewoon-column';
                        let ageLabel = '';
                        let blockIdx = null;
                        if (idx === total - 1) {
                            ageLabel = 'ëŒ€ìš´';
                        } else if (idx === total - 2) {
                            ageLabel = baseAge;
                            blockIdx = 0;
                        } else if (idx < total - 2) {
                            ageLabel = baseAge + (total - 2 - idx) * 10;
                            blockIdx = (total - 2 - idx);
                        }
                        // ì‹­ì‹  ê³„ì‚° (ëŒ€ìš´ ê°„ì§€, ì¼ê°„ ê¸°ì¤€)
                        let ganSibsin = '', jiSibsin = '';
                        if (daewoon.ganji && data.day_ganji) {
                            const dayGan = data.day_ganji[0];
                            const gan = daewoon.ganji[0];
                            const ji = daewoon.ganji[1];
                            ganSibsin = getSibsin(dayGan, gan, true);
                            jiSibsin = getSibsin(dayGan, ji, false);
                        }
                        column.innerHTML = `
                            <div class="daewoon-age" style="font-weight:bold; cursor:pointer; margin-bottom:2px;">${ageLabel}</div>
                            <div style="font-size:13px; color:#888; height:18px;">${ganSibsin}</div>
                            <div class="daewoon-box" style="cursor:pointer;">${daewoon.ganji}</div>
                            <div style="font-size:13px; color:#888; height:18px;">${jiSibsin}</div>
                        `;
                        // í´ë¦­ ì´ë²¤íŠ¸: í•´ë‹¹ blockIdxì˜ ë…„ìš´ ë¼ì¸ë§Œ ì¶œë ¥
                        if (blockIdx !== null) {
                            column.addEventListener('click', () => {
                                showYearunBlock(blockIdx);
                                // ë…„ìš´ í‘œê°€ ê°±ì‹ ëœ í›„, í•´ë‹¹ ë…„ìš´ ë¼ì¸ì˜ ì²« ë²ˆì§¸ ì¹¸ì˜ ë…„ê°„ì„ ì¶”ì¶œí•´ì„œ ì›”ìš´ ìë™ ì¶œë ¥
                                setTimeout(() => {
                                    const yearunTable = document.getElementById('yearunTable');
                                    if (yearunTable) {
                                        const yearCells = yearunTable.querySelectorAll('div[style*="min-width: 80px"]');
                                        if (yearCells.length > 0) {
                                            // ì²« ë²ˆì§¸ ì¹¸(ì™¼ìª½)ì´ blockIdxì— í•´ë‹¹í•˜ëŠ” ë…„ìš´
                                            const firstCell = yearCells[0];
                                            const yearGanDiv = firstCell.querySelectorAll('div')[2];
                                            if (yearGanDiv) {
                                                const yearGan = yearGanDiv.textContent.trim();
                                                showMonthGanji(yearGan);
                                            }
                                        }
                                    }
                                }, 50);
                            });
                        }
                        daewoonContainer.appendChild(column);
                    });

                    // ë…„ìš´ í‘œë¥¼ í•œ ì¤„ë§Œ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
                    function showYearunBlock(blockIdx) {
                        // ê¸°ì¡´ ë…„ìš´ í‘œ/ì›”ê°„ì§€ í‘œ ì‚­ì œ
                        const oldTable = document.getElementById('yearunTable');
                        if (oldTable) oldTable.remove();
                        const oldMonthTable = document.getElementById('monthganjiTable');
                        if (oldMonthTable) oldMonthTable.remove();
                        const yearunTable = document.createElement('div');
                        yearunTable.id = 'yearunTable';
                        yearunTable.style.display = 'flex';
                        yearunTable.style.flexDirection = 'column';
                        yearunTable.style.alignItems = 'center';
                        yearunTable.style.marginTop = '20px';
                        // ë…„ì£¼(ë…„ê°„ì§€) ê¸°ì¤€
                        const yearGanji = data.year_ganji;
                        const gan = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
                        const ji = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
                        const ganStart = gan.indexOf(yearGanji[0]);
                        const jiStart = ji.indexOf(yearGanji[1]);
                        const birthYear = getDateTimeParts().year;
                        const cells = [];
                        for (let col = 0; col < 10; col++) {
                            const idx = blockIdx * 10 + col;
                            const age = baseAge + idx;
                            const year = birthYear + age - 1;
                            const yearGan = gan[(ganStart + age - 1) % 10];
                            const yearJi = ji[(jiStart + age - 1) % 12];
                            // ì‹­ì‹  ê³„ì‚°
                            let ganSibsin = '', jiSibsin = '';
                            if (data.day_ganji) {
                                const dayGan = data.day_ganji[0];
                                ganSibsin = getSibsin(dayGan, yearGan, true);
                                jiSibsin = getSibsin(dayGan, yearJi, false);
                            }
                            const cell = document.createElement('div');
                            cell.style.border = '1px solid #ccc';
                            cell.style.padding = '4px 8px';
                            cell.style.margin = '2px';
                            cell.style.fontSize = '13px';
                            cell.style.minWidth = '80px';
                            cell.style.textAlign = 'center';
                            cell.innerHTML = `
                                <div style="font-weight:bold; font-size:15px; margin-bottom:2px;">${year}</div>
                                <div style="font-size:13px; color:#888;">${ganSibsin}</div>
                                <div style="font-size:18px;">${yearGan}</div>
                                <div style="font-size:18px;">${yearJi}</div>
                                <div style="font-size:13px; color:#888;">${jiSibsin}</div>
                                <div style="font-size:13px; color:#666; margin-top:2px;">${age}</div>
                            `;
                            // ì›”ìš´ í´ë¦­ ì´ë²¤íŠ¸
                            cell.style.cursor = 'pointer';
                            cell.addEventListener('click', () => {
                                // í´ë¦­ëœ ì¹¸ì˜ ê°„ì§€(ë…„ê°„) ì¶”ì¶œ
                                const clickedGanji = (yearGan + yearJi);
                                const clickedYearGan = clickedGanji[0];
                                showMonthGanji(clickedYearGan);
                            });
                            cells.push(cell);
                        }
                        // ì˜¤ë¥¸ìª½ë¶€í„° ì™¼ìª½ìœ¼ë¡œ ì¶œë ¥
                        const rowDiv = document.createElement('div');
                        rowDiv.style.display = 'flex';
                        rowDiv.style.justifyContent = 'center';
                        cells.reverse().forEach(cell => rowDiv.appendChild(cell));
                        yearunTable.appendChild(rowDiv);
                        daewoonContainer.parentNode.appendChild(yearunTable);
                    }

                    // ì›”ê°„ì§€ í‘œ ì¶œë ¥ í•¨ìˆ˜
                    function showMonthGanji(yearGan) {
                        // ê¸°ì¡´ ì›”ìš´ í‘œ ì‚­ì œ
                        let oldMonthTable = document.getElementById('monthganjiTable');
                        if (oldMonthTable) oldMonthTable.remove();
                        const monthTable = document.createElement('div');
                        monthTable.id = 'monthganjiTable';
                        monthTable.style.display = 'flex';
                        monthTable.style.justifyContent = 'center';
                        monthTable.style.marginTop = '10px';
                        monthTable.style.background = '#f9f9e3'; // ì„ì‹œ ë°°ê²½ìƒ‰(í™•ì¸ìš©)
                        const monthGanjiMap = {
                          'ç”²': ['ä¹™ä¸‘','ä¸™å¯…','ä¸å¯','æˆŠè¾°','å·±å·³','åºšåˆ','è¾›æœª','å£¬ç”³','ç™¸é…‰','ç”²æˆŒ','ä¹™äº¥','ä¸™ì'],
                          'å·±': ['ä¹™ä¸‘','ä¸™å¯…','ä¸å¯','æˆŠè¾°','å·±å·³','åºšåˆ','è¾›æœª','å£¬ç”³','ç™¸é…‰','ç”²æˆŒ','ä¹™äº¥','ä¸™ì'],
                          'ä¹™': ['ä¸ä¸‘','æˆŠå¯…','å·±å¯','åºšè¾°','è¾›å·³','å£¬åˆ','ç™¸æœª','ç”²ç”³','ä¹™é…‰','ä¸™æˆŒ','ä¸äº¥','æˆŠì'],
                          'åºš': ['ä¸ä¸‘','æˆŠå¯…','å·±å¯','åºšè¾°','è¾›å·³','å£¬åˆ','ç™¸æœª','ç”²ç”³','ä¹™é…‰','ä¸™æˆŒ','ä¸äº¥','æˆŠì'],
                          'ä¸™': ['å·±ä¸‘','åºšå¯…','è¾›å¯','å£¬è¾°','ç™¸å·³','ç”²åˆ','ä¹™æœª','ä¸™ç”³','ä¸é…‰','æˆŠæˆŒ','å·±äº¥','åºšì'],
                          'è¾›': ['å·±ä¸‘','åºšå¯…','è¾›å¯','å£¬è¾°','ç™¸å·³','ç”²åˆ','ä¹™æœª','ä¸™ç”³','ä¸é…‰','æˆŠæˆŒ','å·±äº¥','åºšì'],
                          'ä¸': ['è¾›ä¸‘','å£¬å¯…','ç™¸å¯','ç”²è¾°','ä¹™å·³','ä¸™åˆ','ä¸æœª','æˆŠç”³','å·±é…‰','åºšæˆŒ','è¾›äº¥','å£¬ì'],
                          'å£¬': ['è¾›ä¸‘','å£¬å¯…','ç™¸å¯','ç”²è¾°','ä¹™å·³','ä¸™åˆ','ä¸æœª','æˆŠç”³','å·±é…‰','åºšæˆŒ','è¾›äº¥','å£¬ì'],
                          'æˆŠ': ['ç™¸ä¸‘','ç”²å¯…','ä¹™å¯','ä¸™è¾°','ä¸å·³','æˆŠåˆ','å·±æœª','åºšç”³','è¾›é…‰','å£¬æˆŒ','ç™¸äº¥','ç”²ì'],
                          'ç™¸': ['ç™¸ä¸‘','ç”²å¯…','ä¹™å¯','ä¸™è¾°','ä¸å·³','æˆŠåˆ','å·±æœª','åºšç”³','è¾›é…‰','å£¬æˆŒ','ç™¸äº¥','ç”²ì'],
                        };
                        const ganjiArr = monthGanjiMap[yearGan] || [];
                        const cells = [];
                        for (let i = 0; i < 12; i++) {
                            const ganji = ganjiArr[i] || '';
                            const gan = ganji[0] || '';
                            const ji = ganji[1] || '';
                            let ganSibsin = '', jiSibsin = '';
                            if (data.day_ganji) {
                                const dayGan = data.day_ganji[0];
                                ganSibsin = getSibsin(dayGan, gan, true);
                                jiSibsin = getSibsin(dayGan, ji, false);
                            }
                            const cell = document.createElement('div');
                            cell.style.border = '1px solid #aaa';
                            cell.style.padding = '4px 8px';
                            cell.style.margin = '2px';
                            cell.style.fontSize = '13px';
                            cell.style.minWidth = '60px';
                            cell.style.textAlign = 'center';
                            cell.style.overflow = 'hidden';
                            cell.style.textOverflow = 'ellipsis';
                            cell.style.whiteSpace = 'nowrap';
                            // ê°„ì§€ë¥¼ ì„¸ë¡œë¡œ ì¶œë ¥
                            cell.innerHTML = `
                                <div style="font-weight:bold; font-size:15px; margin-bottom:2px;">${i+1}ì›”</div>
                                <div style="font-size:13px; color:#888;">${ganSibsin}</div>
                                <div style="font-size:18px;">${gan}</div>
                                <div style="font-size:18px;">${ji}</div>
                                <div style="font-size:13px; color:#888;">${jiSibsin}</div>
                            `;
                            // ë‹¬ë ¥ ëª¨ë‹¬ ì´ë²¤íŠ¸
                            cell.style.cursor = 'pointer';
                            cell.addEventListener('click', () => {
                                showCalendarModal(daewoonContainer, i+1, year);
                            });
                            cells.push(cell);
                        }
                        // ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ì¶œë ¥
                        cells.reverse().forEach(cell => monthTable.appendChild(cell));
                        // ë…„ìš´ í‘œ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€
                        const yearunTable = document.getElementById('yearunTable');
                        if (yearunTable && yearunTable.parentNode) {
                            yearunTable.parentNode.insertBefore(monthTable, yearunTable.nextSibling);
                        } else {
                            daewoonContainer.parentNode.appendChild(monthTable);
                        }
                    }

                    // í˜ì´ì§€ ë¡œë“œì‹œ í˜„ì¬ ë‚˜ì´ëŒ€ì˜ ë…„ìš´ ë¼ì¸ë§Œ ì¶œë ¥
                    const now = new Date();
                    const birthYear = getDateTimeParts().year;
                    const currentAge = now.getFullYear() - birthYear + 1;
                    let blockIdx = Math.floor((currentAge - baseAge) / 10);
                    if (blockIdx < 0) blockIdx = 0;
                    if (blockIdx > 9) blockIdx = 9;
                    showYearunBlock(blockIdx);

                    // í˜„ì¬ ë…„ë„ì˜ ì›”ìš´ì„ ìë™ ì¶œë ¥
                    (function showCurrentYearMonthUn() {
                        // ë…„ìš´ ë¼ì¸ì—ì„œ í˜„ì¬ ë…„ë„ì— í•´ë‹¹í•˜ëŠ” ì¹¸ì˜ ë…„ê°„ ì¶”ì¶œ
                        const yearGanji = data.year_ganji;
                        const gan = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
                        const ji = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
                        const ganStart = gan.indexOf(yearGanji[0]);
                        const jiStart = ji.indexOf(yearGanji[1]);
                        const idx = currentAge - baseAge;
                        if (idx >= 0 && idx < 100) {
                            const yearGan = gan[(ganStart + currentAge - 1) % 10];
                            showMonthGanji(yearGan);
                        }
                    })();

                    // [ì¶”ê°€] ì‚¬ì£¼ì›êµ­ ê°±ì‹  í›„ ì›”ìš´ í‘œë„ í•­ìƒ ìµœì‹ ìœ¼ë¡œ ê°±ì‹ 
                    setTimeout(() => {
                        const yearunTable = document.getElementById('yearunTable');
                        if (yearunTable) {
                            const yearCells = yearunTable.querySelectorAll('div[style*="min-width: 80px"]');
                            if (yearCells.length > 0) {
                                // yearCellsëŠ” ì™¼â†’ì˜¤ ìˆœì„œì´ë¯€ë¡œ, ë§ˆì§€ë§‰ ì¹¸ì´ ìµœì‹ 
                                const lastCell = yearCells[yearCells.length - 1];
                                // ë…„ê°„ ì¶”ì¶œ (ìœ„ì—ì„œ 3ë²ˆì§¸ div)
                                const yearGanDiv = lastCell.querySelectorAll('div')[2];
                                if (yearGanDiv) {
                                    const yearGan = yearGanDiv.textContent.trim();
                                    showMonthGanji(yearGan);
                                }
                            }
                        }
                    }, 100);

                    // ìµœê·¼ ì‚¬ì£¼ ìë™ ì €ì¥ í•¨ìˆ˜
                    addRecentSaju();

                    // ì§€ì¥ê°„ ë§¤í•‘ í…Œì´ë¸”
                    const jijiToJijanggan = {
                        'å­': 'å£¬ - ç™¸',
                        'ä¸‘': 'ç™¸è¾›å·±',
                        'å¯…': 'æˆŠä¸™ç”²',
                        'å¯': 'ç”² - ä¹™',
                        'è¾°': 'ä¹™ç™¸æˆŠ',
                        'å·³': 'æˆŠåºšä¸™',
                        'åˆ': 'ä¸™å·±ä¸',
                        'æœª': 'ä¸ä¹™å·±',
                        'ç”³': 'æˆŠå£¬åºš',
                        'é…‰': 'åºš - è¾›',
                        'æˆŒ': 'è¾›ä¸æˆŠ',
                        'äº¥': 'æˆŠç”²å£¬'
                    };
                    // ì§€ì¥ê°„ í• ë‹¹ í•¨ìˆ˜
                    function setJijanggan() {
                        const yearJi = (data.year_ganji && data.year_ganji[1]) ? data.year_ganji[1] : '';
                        const monthJi = (data.month_ganji && data.month_ganji[1]) ? data.month_ganji[1] : '';
                        const dayJi = (data.day_ganji && data.day_ganji[1]) ? data.day_ganji[1] : '';
                        const hourJi = (data.hour_ganji && data.hour_ganji[1]) ? data.hour_ganji[1] : '';
                        document.getElementById('yearJijanggan').textContent = jijiToJijanggan[yearJi] || '';
                        document.getElementById('monthJijanggan').textContent = jijiToJijanggan[monthJi] || '';
                        document.getElementById('dayJijanggan').textContent = jijiToJijanggan[dayJi] || '';
                        document.getElementById('hourJijanggan').textContent = jijiToJijanggan[hourJi] || '';
                    }
                    setJijanggan();

                    // 12ì‹ ì‚´ ê·œì¹™ í…Œì´ë¸” ë° í•¨ìˆ˜
                    const shinsalTable = {
                        'å·³é…‰ä¸‘': ['å·³','ì§€ì‚´','åˆ','ë…„ì‚´','æœª','ì›”ì‚´','ç”³','ë§ì‹ ','é…‰','ì¥ì„±','æˆŒ','ë°˜ì•ˆ','äº¥','ì—­ë§ˆ','å­','ìœ¡í•´','ä¸‘','í™”ê°œ','å¯…','ê²ì‚´','å¯','ì¬ì‚´','è¾°','ì²œì‚´'],
                        'å¯…åˆæˆŒ': ['å¯…','ì§€ì‚´','å¯','ë…„ì‚´','è¾°','ì›”ì‚´','å·³','ë§ì‹ ','åˆ','ì¥ì„±','æœª','ë°˜ì•ˆ','ç”³','ì—­ë§ˆ','é…‰','ìœ¡í•´','æˆŒ','í™”ê°œ','äº¥','ê²ì‚´','å­','ì¬ì‚´','ä¸‘','ì²œì‚´'],
                        'äº¥å¯æœª': ['äº¥','ì§€ì‚´','å­','ë…„ì‚´','ä¸‘','ì›”ì‚´','å¯…','ë§ì‹ ','å¯','ì¥ì„±','è¾°','ë°˜ì•ˆ','å·³','ì—­ë§ˆ','åˆ','ìœ¡í•´','æœª','í™”ê°œ','ç”³','ê²ì‚´','é…‰','ì¬ì‚´','æˆŒ','ì²œì‚´'],
                        'ç”³å­è¾°': ['ç”³','ì§€ì‚´','é…‰','ë…„ì‚´','æˆŒ','ì›”ì‚´','äº¥','ë§ì‹ ','å­','ì¥ì„±','ä¸‘','ë°˜ì•ˆ','å¯…','ì—­ë§ˆ','å¯','ìœ¡í•´','è¾°','í™”ê°œ','å·³','ê²ì‚´','åˆ','ì¬ì‚´','æœª','ì²œì‚´']
                    };
                    function getShinsalMap(yearJi) {
                        let key = '';
                        if ('å·³é…‰ä¸‘'.includes(yearJi)) key = 'å·³é…‰ä¸‘';
                        else if ('å¯…åˆæˆŒ'.includes(yearJi)) key = 'å¯…åˆæˆŒ';
                        else if ('äº¥å¯æœª'.includes(yearJi)) key = 'äº¥å¯æœª';
                        else if ('ç”³å­è¾°'.includes(yearJi)) key = 'ç”³å­è¾°';
                        else return {};
                        const arr = shinsalTable[key];
                        const map = {};
                        for (let i = 0; i < arr.length; i += 2) {
                            map[arr[i]] = arr[i+1];
                        }
                        return map;
                    }
                    function setShinsal() {
                        const yearJi = (data.year_ganji && data.year_ganji[1]) ? data.year_ganji[1] : '';
                        const monthJi = (data.month_ganji && data.month_ganji[1]) ? data.month_ganji[1] : '';
                        const dayJi = (data.day_ganji && data.day_ganji[1]) ? data.day_ganji[1] : '';
                        const hourJi = (data.hour_ganji && data.hour_ganji[1]) ? data.hour_ganji[1] : '';
                        const shinsalMap = getShinsalMap(yearJi);
                        document.getElementById('yearShinsal').textContent = shinsalMap[yearJi] || '';
                        document.getElementById('monthShinsal').textContent = shinsalMap[monthJi] || '';
                        document.getElementById('dayShinsal').textContent = shinsalMap[dayJi] || '';
                        document.getElementById('hourShinsal').textContent = shinsalMap[hourJi] || '';
                    }
                    setShinsal();

                    // 12ìš´ì„± ê·œì¹™ í…Œì´ë¸”
                    const unseongTable = {
                        'ç”²': ['äº¥','å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ'],
                        'ä¹™': ['åˆ','å·³','è¾°','å¯','å¯…','ä¸‘','å­','äº¥','æˆŒ','é…‰','ç”³','æœª'],
                        'ä¸™': ['å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥','å­','ä¸‘'],
                        'ä¸': ['é…‰','ç”³','æœª','åˆ','å·³','è¾°','å¯','å¯…','ä¸‘','å­','äº¥','æˆŒ'],
                        'æˆŠ': ['å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥','å­','ä¸‘'],
                        'å·±': ['é…‰','ç”³','æœª','åˆ','å·³','è¾°','å¯','å¯…','ä¸‘','å­','äº¥','æˆŒ'],
                        'åºš': ['å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥','å­','ä¸‘','å¯…','å¯','è¾°'],
                        'è¾›': ['å­','äº¥','æˆŒ','é…‰','ç”³','æœª','åˆ','å·³','è¾°','å¯','å¯…','ä¸‘'],
                        'å£¬': ['ç”³','é…‰','æˆŒ','äº¥','å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª'],
                        'ç™¸': ['å¯','å¯…','ä¸‘','å­','äº¥','æˆŒ','é…‰','ç”³','æœª','åˆ','å·³','è¾°']
                    };
                    const unseongNames = ['ì¥ìƒ','ëª©ìš•','ê´€ëŒ€','ê±´ë¡','ì œì™•','ì‡ ','ë³‘','ì‚¬','ë¬˜','ì ˆ','íƒœ','ì–‘'];

                    function getUnseong(dayGan, ji) {
                        if (!dayGan || !ji) return '';
                        const jiList = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
                        const jiIndex = jiList.indexOf(ji);
                        if (jiIndex === -1) return '';
                        const unseongOrder = unseongTable[dayGan];
                        if (!unseongOrder) return '';
                        const unseongIndex = unseongOrder.indexOf(ji);
                        if (unseongIndex === -1) return '';
                        return unseongNames[unseongIndex];
                    }

                    function setUnseong() {
                        const dayGan = (data.day_ganji && data.day_ganji[0]) ? data.day_ganji[0] : '';
                        const yearJi = (data.year_ganji && data.year_ganji[1]) ? data.year_ganji[1] : '';
                        const monthJi = (data.month_ganji && data.month_ganji[1]) ? data.month_ganji[1] : '';
                        const dayJi = (data.day_ganji && data.day_ganji[1]) ? data.day_ganji[1] : '';
                        const hourJi = (data.hour_ganji && data.hour_ganji[1]) ? data.hour_ganji[1] : '';
                        
                        document.getElementById('yearUnseong').textContent = getUnseong(dayGan, yearJi);
                        document.getElementById('monthUnseong').textContent = getUnseong(dayGan, monthJi);
                        document.getElementById('dayUnseong').textContent = getUnseong(dayGan, dayJi);
                        document.getElementById('hourUnseong').textContent = getUnseong(dayGan, hourJi);
                    }

                    // ì‚¬ì£¼ì›êµ­ ì¡°íšŒ ì„±ê³µ ì‹œ 12ìš´ì„± ì„¤ì •
                    if (response.ok) {
                        setShinsal();
                        setUnseong(); // 12ìš´ì„± ì„¤ì • ì¶”ê°€
                        // ì‚¬ì£¼ ì •ë³´ ë°” ì±„ìš°ê¸° (ì˜¤ë¥˜ ë°©ì§€: ê°’ ì—†ì„ ë•Œ ë¹ˆ ë¬¸ìì—´, DOM ì²´í¬)
                        const infoSolarDate = document.getElementById('infoSolarDate');
                        const infoLunarDate = document.getElementById('infoLunarDate');
                        const infoAge = document.getElementById('infoAge');
                        const infoGender = document.getElementById('infoGender');

                        if (infoSolarDate) infoSolarDate.textContent = 'ì–‘ë ¥: ' + (typeof data.solar_date === 'string' ? data.solar_date : '');
                        if (infoLunarDate) infoLunarDate.textContent = 'ìŒë ¥: ' + (typeof data.lunar_date === 'string' ? data.lunar_date : '');

                        // ë‚˜ì´ ê³„ì‚° (solar_dateê°€ 'YYYYë…„ MMì›” DDì¼' í˜•ì‹ì´ ì•„ë‹ ë•Œë„ ëŒ€ë¹„)
                        let age = '';
                        if (typeof data.solar_date === 'string' && /^\d{4}/.test(data.solar_date)) {
                            const birthYear = parseInt(data.solar_date.slice(0,4), 10);
                            if (!isNaN(birthYear)) {
                                const now = new Date();
                                age = now.getFullYear() - birthYear + 1;
                            }
                        }
                        if (infoAge) infoAge.textContent = 'ë‚˜ì´: ' + (age ? age : '');

                        // ì„±ë³„
                        let genderText = '';
                        if (typeof data.gender === 'string') {
                            genderText = data.gender === 'M' ? 'ë‚¨' : (data.gender === 'F' ? 'ì—¬' : '');
                        } else if (document.getElementById('gender')) {
                            // fallback: í˜„ì¬ ì…ë ¥ê°’
                            const gval = document.getElementById('gender').value;
                            genderText = gval === 'M' ? 'ë‚¨' : (gval === 'F' ? 'ì—¬' : '');
                        }
                        if (infoGender) infoGender.textContent = 'ì„±ë³„: ' + genderText;
                    }
                } else {
                    alert(data && data.error ? data.error : 'ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    // info bar ì´ˆê¸°í™”
                    const infoSolarDate = document.getElementById('infoSolarDate');
                    const infoLunarDate = document.getElementById('infoLunarDate');
                    const infoAge = document.getElementById('infoAge');
                    const infoGender = document.getElementById('infoGender');
                    if (infoSolarDate) infoSolarDate.textContent = '';
                    if (infoLunarDate) infoLunarDate.textContent = '';
                    if (infoAge) infoAge.textContent = '';
                    if (infoGender) infoGender.textContent = '';
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error('Error:', error);
            }
        });

        document.getElementById('unknownHour').addEventListener('change', function() {
            const hourInput = document.getElementById('hour');
            const minuteInput = document.getElementById('minute');
            if (this.checked) {
                hourInput.value = 0;
                minuteInput.value = 0;
                hourInput.disabled = true;
                minuteInput.disabled = true;
            } else {
                // ì‹œ ëª¨ë¦„ í•´ì œ ì‹œ í˜„ì¬ ì‹œê°„ ìë™ì…ë ¥
                const now = new Date();
                hourInput.value = now.getHours();
                minuteInput.value = now.getMinutes();
                hourInput.disabled = false;
                minuteInput.disabled = false;
            }
        });

        // ë‹¬ë ¥ ëª¨ë‹¬ í•¨ìˆ˜
        function showCalendarModal(parentElem, month, year) {
            // ê¸°ì¡´ ëª¨ë‹¬ ì‚­ì œ
            let oldModal = document.getElementById('calendarModal');
            if (oldModal) oldModal.remove();
            // ë‹¬ë ¥ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'calendarModal';
            modal.style.position = 'fixed';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.3)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '9999';
            const calBox = document.createElement('div');
            calBox.style.background = '#fff';
            calBox.style.padding = '20px';
            calBox.style.borderRadius = '10px';
            calBox.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            calBox.style.minWidth = '320px';
            // ë‹¬ë ¥ í—¤ë”
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '10px';
            header.innerHTML = `<b>${year}ë…„ ${month}ì›”</b>`;
            // ë‹«ê¸° ë²„íŠ¼
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'ë‹«ê¸°';
            closeBtn.style.marginLeft = '10px';
            closeBtn.onclick = () => modal.remove();
            header.appendChild(closeBtn);
            calBox.appendChild(header);
            // ë‹¬ë ¥ í‘œ
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            let tr = document.createElement('tr');
            days.forEach(d => {
                const th = document.createElement('th');
                th.textContent = d;
                th.style.border = '1px solid #ccc';
                th.style.padding = '2px';
                tr.appendChild(th);
            });
            table.appendChild(tr);
            // ë‚ ì§œ ì±„ìš°ê¸°
            const firstDay = new Date(year, month-1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();
            tr = document.createElement('tr');
            for (let i = 0; i < firstDay; i++) {
                const td = document.createElement('td');
                td.innerHTML = '&nbsp;';
                tr.appendChild(td);
            }
            for (let d = 1; d <= lastDate; d++) {
                if ((tr.children.length) % 7 === 0 && d !== 1) {
                    table.appendChild(tr);
                    tr = document.createElement('tr');
                }
                const td = document.createElement('td');
                // 60ê°‘ì ê³„ì‚°
                const ganzhi60 = [
                    'ç”²å­','ä¹™ä¸‘','ä¸™å¯…','ä¸å¯','æˆŠè¾°','å·±å·³','åºšåˆ','è¾›æœª','å£¬ç”³','ç™¸é…‰',
                    'ç”²æˆŒ','ä¹™äº¥','ä¸™å­','ä¸ä¸‘','æˆŠå¯…','å·±å¯','åºšè¾°','è¾›å·³','å£¬åˆ','ç™¸æœª',
                    'ç”²ç”³','ä¹™é…‰','ä¸™æˆŒ','ä¸äº¥','æˆŠå­','å·±ä¸‘','åºšå¯…','è¾›å¯','å£¬è¾°','ç™¸å·³',
                    'ç”²åˆ','ä¹™æœª','ä¸™ç”³','ä¸é…‰','æˆŠæˆŒ','å·±äº¥','åºšå­','è¾›ä¸‘','å£¬å¯…','ç™¸å¯',
                    'ç”²è¾°','ä¹™å·³','ä¸™åˆ','ä¸æœª','æˆŠç”³','å·±é…‰','åºšæˆŒ','è¾›äº¥','å£¬å­','ç™¸ä¸‘',
                    'ç”²å¯…','ä¹™å¯','ä¸™è¾°','ä¸å·³','æˆŠåˆ','å·±æœª','åºšç”³','è¾›é…‰','å£¬æˆŒ','ç™¸äº¥'
                ];
                const baseDate = new Date(1984, 1, 2); // ì›” 0-indexed
                const thisDate = new Date(year, month-1, d);
                const diffDays = Math.floor((thisDate - baseDate) / (1000*60*60*24));
                let ganzhi = '';
                if (diffDays >= 0) {
                    ganzhi = ganzhi60[diffDays % 60];
                } else {
                    ganzhi = ganzhi60[(60 + (diffDays % 60)) % 60];
                }
                const ganzhiVertical = ganzhi.split('').join('<br>');
                td.innerHTML = `<div>${d}</div><div style='font-size:11px;color:#888;'>${ganzhiVertical}</div>`;
                td.style.border = '1px solid #ccc';
                td.style.padding = '2px';
                // ë‚ ì§œ í´ë¦­ ì‹œ ì…ë ¥ë€ì— ë°˜ì˜í•˜ê³  ë‹¬ë ¥ ë‹«ê¸° ë° ì‚¬ì£¼ì›êµ­ ìë™ ì¡°íšŒ
                td.style.cursor = 'pointer';
                td.onclick = () => {
                    // ê¸°ì¡´ datetimeInput ê°’ì—ì„œ ì‹œ/ë¶„ë§Œ ì¶”ì¶œ
                    const datetimeInput = document.getElementById('datetimeInput');
                    let val = datetimeInput.value.trim();
                    let hour = '00', minute = '00';
                    if (val.length === 12) {
                        hour = val.slice(8, 10);
                        minute = val.slice(10, 12);
                    }
                    // ìƒˆ ë‚ ì§œë¡œ datetimeInput ê°’ ê°±ì‹ 
                    const mm = month.toString().padStart(2, '0');
                    const dd = d.toString().padStart(2, '0');
                    datetimeInput.value = `${year}${mm}${dd}${hour}${minute}`;
                    modal.remove();
                    setTimeout(() => {
                        document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
                    }, 50);
                };
                tr.appendChild(td);
            }
            while (tr.children.length < 7) {
                const td = document.createElement('td');
                td.innerHTML = '&nbsp;';
                tr.appendChild(td);
            }
            table.appendChild(tr);
            calBox.appendChild(table);
            modal.appendChild(calBox);
            document.body.appendChild(modal);
        }

        // ì‚¬ì£¼ ì €ì¥/ì¡°íšŒ ê¸°ëŠ¥
        // ì €ì¥ ë²„íŠ¼ í´ë¦­
        document.getElementById('saveSajuBtn').onclick = function() {
            document.getElementById('saveMemo').value = '';
            document.getElementById('saveModal').style.display = 'flex';
        };
        // ì €ì¥ ëª¨ë‹¬ ì·¨ì†Œ
        document.getElementById('saveModalCancel').onclick = function() {
            document.getElementById('saveModal').style.display = 'none';
        };
        // ì €ì¥ ëª¨ë‹¬ ì €ì¥
        document.getElementById('saveModalOk').onclick = function() {
            const memo = document.getElementById('saveMemo').value.trim();
            if (memo.length === 0) {
                alert('ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            // í˜„ì¬ ì…ë ¥ê°’ ì €ì¥
            const sajuData = {
                memo,
                savedAt: new Date().toISOString(),
                gender: document.getElementById('gender').value,
                calendarType: document.getElementById('calendarType').value,
                datetime: document.getElementById('datetimeInput').value,
                unknownHour: document.getElementById('unknownHour').checked
            };
            let list = JSON.parse(localStorage.getItem('sajuList') || '[]');
            list.unshift(sajuData); // ìµœì‹ ì´ ìœ„ë¡œ
            localStorage.setItem('sajuList', JSON.stringify(list));
            document.getElementById('saveModal').style.display = 'none';
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        };
        // ì¡°íšŒ ë²„íŠ¼ í´ë¦­
        document.getElementById('loadSajuBtn').onclick = function() {
            const list = JSON.parse(localStorage.getItem('sajuList') || '[]');
            const loadList = document.getElementById('loadList');
            loadList.innerHTML = '';
            if (list.length === 0) {
                loadList.innerHTML = '<div style="color:#888;">ì €ì¥ëœ ì‚¬ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                list.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.style.border = '1px solid #ccc';
                    div.style.borderRadius = '6px';
                    div.style.padding = '8px';
                    div.style.marginBottom = '6px';
                    div.style.cursor = 'pointer';
                    div.style.background = '#f8f9fa';
                    div.innerHTML = `<b>${item.memo}</b> <span style="color:#888;font-size:12px;">(${item.savedAt.slice(0,16).replace('T',' ')})</span><br>
                        <span style="font-size:12px;">${item.gender==='M'?'ë‚¨':'ì—¬'}, ${item.calendarType==='lunar'?'ìŒë ¥':'ì–‘ë ¥'}, ${item.datetime}, ${item.unknownHour?'ì‹œëª¨ë¦„':''}</span>`;
                    div.onclick = function() {
                        // ì…ë ¥ê°’ ë°˜ì˜
                        document.getElementById('gender').value = item.gender;
                        document.getElementById('calendarType').value = item.calendarType;
                        document.getElementById('datetimeInput').value = item.datetime;
                        document.getElementById('unknownHour').checked = item.unknownHour;
                        // ì‹œëª¨ë¦„ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                        document.getElementById('unknownHour').dispatchEvent(new Event('change'));
                        document.getElementById('loadModal').style.display = 'none';
                        setTimeout(() => {
                            document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
                        }, 100);
                    };
                    loadList.appendChild(div);
                });
            }
            document.getElementById('loadModal').style.display = 'flex';
        };
        // ì¡°íšŒ ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('loadModalClose').onclick = function() {
            document.getElementById('loadModal').style.display = 'none';
        };

        // ìµœê·¼ ë²„íŠ¼/ëª¨ë‹¬ ê¸°ëŠ¥
        document.getElementById('recentSajuBtn').onclick = function() {
            const list = JSON.parse(localStorage.getItem('recentSajuList') || '[]');
            const recentList = document.getElementById('recentList');
            recentList.innerHTML = '';
            if (list.length === 0) {
                recentList.innerHTML = '<div style="color:#888;">ìµœê·¼ ì¡°íšŒí•œ ì‚¬ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                list.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.style.border = '1px solid #ccc';
                    div.style.borderRadius = '6px';
                    div.style.padding = '8px';
                    div.style.marginBottom = '6px';
                    div.style.cursor = 'pointer';
                    div.style.background = '#f8f9fa';
                    div.innerHTML = `<span style="color:#888;font-size:12px;">${item.savedAt.slice(0,16).replace('T',' ')}</span><br>
                        <span style="font-size:12px;">${item.gender==='M'?'ë‚¨':'ì—¬'}, ${item.calendarType==='lunar'?'ìŒë ¥':'ì–‘ë ¥'}, ${item.datetime}, ${item.unknownHour?'ì‹œëª¨ë¦„':''}</span>`;
                    div.onclick = function() {
                        document.getElementById('gender').value = item.gender;
                        document.getElementById('calendarType').value = item.calendarType;
                        document.getElementById('datetimeInput').value = item.datetime;
                        document.getElementById('unknownHour').checked = item.unknownHour;
                        document.getElementById('unknownHour').dispatchEvent(new Event('change'));
                        document.getElementById('recentModal').style.display = 'none';
                        setTimeout(() => {
                            document.getElementById('sajuForm').dispatchEvent(new Event('submit', {cancelable: true}));
                        }, 100);
                    };
                    recentList.appendChild(div);
                });
            }
            document.getElementById('recentModal').style.display = 'flex';
        };
        document.getElementById('recentModalClose').onclick = function() {
            document.getElementById('recentModal').style.display = 'none';
        };

        // ìµœê·¼ ì‚¬ì£¼ ìë™ ì €ì¥ í•¨ìˆ˜
        function addRecentSaju() {
            const recent = {
                gender: document.getElementById('gender').value,
                calendarType: document.getElementById('calendarType').value,
                datetime: document.getElementById('datetimeInput').value,
                unknownHour: document.getElementById('unknownHour').checked,
                savedAt: new Date().toISOString()
            };
            let list = JSON.parse(localStorage.getItem('recentSajuList') || '[]');
            // ì¤‘ë³µ ì œê±°(ë™ì¼ ì…ë ¥ê°’)
            list = list.filter(item =>
                !(item.gender === recent.gender &&
                  item.calendarType === recent.calendarType &&
                  item.datetime === recent.datetime &&
                  item.unknownHour === recent.unknownHour)
            );
            list.unshift(recent);
            if (list.length > 50) list = list.slice(0, 50);
            localStorage.setItem('recentSajuList', JSON.stringify(list));
        }

        // ë‹¬ë ¥ ë²„íŠ¼ í´ë¦­ ì‹œ í˜„ì¬ ì›”ì˜ ë‹¬ë ¥ ëª¨ë‹¬ ë„ìš°ê¸°
        document.getElementById('calendarBtn').onclick = function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const daewoonContainer = document.getElementById('daewoonContainer');
            showCalendarModal(daewoonContainer, month, year);
        };
    </script>
</body>
</html> 